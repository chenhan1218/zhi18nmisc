<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="zh-TW">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Linux電子報的樣本檔</title>
  <link href="../../LGStyle.css" rel="stylesheet" type="text/css">
  <link href="../../../style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="GazetteLogo"><a href="http://www.linuxgazette.com/"><img
 src="../../gx/lglogo_200x41.png" alt="Linux Gazette 雜誌" width="200"
 height="41" longdesc="../linuxgaette.rdf"> </a><br>
<a href="http://www.linuxgazette.com/copying.html">Copyright</a>©1996-2003<br>
Specialized Systems Consultants, Inc.</div>
<div class="CLDPAddr">CLDP</div>
<div class="CLDPFull">Chinese Linux Documentation Project</div>
<hr>
<p class="BarTop"><a href="../../../index.html" title="連到首頁"
 hreflang="zh-TW" accesskey="H">首頁(H)</a>｜<a href="../../../howto/"
 title="連到和 HOWTO  相關資訊" hreflang="zh-TW" accesskey="T">HOWTO(T)</a>｜<a
 href="../../../guide/" title="連到和指南相關的資訊" hreflang="zh-TW"
 accesskey="G">指南(G)</a>｜<a href="../../../FAQ/" title="連到和問答集相關的資訊"
 hreflang="zh-TW" accesskey="F">FAQ(F)</a>｜<a href="../../../man/"
 title="連到和手冊頁有關的資訊" hreflang="zh-TW" accesskey="M">手冊頁(M)</a>｜<a
 href="../../index.html" title="Linux電子報為一個月發行一期的雜誌" hreflang="zh-TW"
 accesskey="L">Linux電子報(L)</a>｜<a href="../../../LF/"
 title="LinuxFocus 為兩個月發行一期的雜誌" hreflang="zh-TW" accesskey="S">LinuxFocus(S)</a></p>
<hr>
<div class="DivCover">
<div class="TitleHead"> Perl One-Liner of the Month: The Adventure of
the Arbitrary Archives <br>
By <a href="file:///Data/CLDP/LG/2003/02/authors/okopnik.html">Ben
Okopnik</a> </div>
<div>
<p class="BarTop"><a href="../../index.html">Linux電子報首頁</a>｜<a
 href="index.html">目錄</a>｜<a href="../../faq/index.html">FAQ</a><br>
讓 Linux 更加有趣呦！</p>
</div>
<div>
<h2>內容</h2>
</div>
<div>
<p>Spring was in full bloom, and Woomert Foonly was enjoying another
perfect day. It had featured a trivially easy configuration of a
1,000-node Linux cluster, and had been brought to an acme by lunching
on Moroccan <i>b'stila</i> with just a touch of <i>ras el hanout</i>
curry and a fruited <i>couscous</i> on the side, complemented by a
dessert of sweet rice with cinnamon. All was at peace... until Frink
Ooblick burst in, supporting - almost carrying - a man who seemed to be
in the last extremity of shock. Frink helped him to the couch, then
dropped into the easy chair, clearly exhausted by his effort. </p>
<p> -- "Woomert, it's simply scandalous. This is Resolv Dot Conf, a
humble... erm, well, a sysadmin, anyway. Recently, he was cruelly
forced to install some kind of a legacy OS on his manager's computer -
can you imagine? - and now, he's being asked to do something that
sounds nearly impossible, although I could only get scant details. He
had heard of your reputation (who hasn't, these days?), and was coming
to see if you could help him, but collapsed in the street just outside
your door due to the residual shock and a severe Jolt Cola deficiency.
As to the problem... well, I'll let him tell you." </p>
<p>Woomert had been tending to their guest while listening, with the
result that the latter now looked almost normal. Indeed, Woomert's
"sysadmin-grade coffee" was well-known among the <i>cognoscenti</i> for
its restorative powers, although the exact recipe (it was thought to
have Espresso Alexander and coffee ice cream somewhere in its ancestry,
but the various theories diverged widely after that point) remained a
deep secret. </p>
<p>Now, though, the famous detective's eyes sharpened to that look of
concentration he habitually wore while working. </p>
<p> -- "Please state your problem clearly and concisely." </p>
<p>The quickly recovering sysadmin shook his head mournfully. </p>
<p> -- "Well, Mr. Foonly... you see, what I have is a script that
processes the data submitted to us by our satellite offices. The thing
is, it all comes in various forms: we're a health insurance data
processor, and every company's format is different. Not only that, but
the way everyone submits the data is different: some just send us a
plain data file, others use 'gzip', or 'compress', or 'bzip', or 'rar',
or even 'tar' <i>and</i> 'compress' (or 'gzip'), and others -
fortunately, all of those are just plain data - hand us a live data
stream out of their proprietary applications. Our programmers handled
the various format conversions as soon as they got the specs, but this
arbitrary compression problem was left up to me, and it's got me up a
tree!" </p>
<p>He stopped to take a deep breath and another gulp of Woomert's
coffee, which seemed to revive him further, although he still sat
hunched over, his forehead resting on his hand. </p>
<p>"Anyway, at this point, making it all work still requires human
intervention; we've got two people doing nothing but sorting and
decompressing the files, all day long. If it wasn't for that, the whole
system could be completely automated... and of course, management keeps
at me: 'Why isn't it fixed yet? Aren't you computer people supposed
to...' and so on." </p>
<p>When he finally sat up and looked at Woomert, his jaw was firmly
set. He was a man clearly resigned to his fate, no matter how horrible. </p>
<p>"Be honest with me, Mr. Foonly. Is there a possibility of a
solution, or am I finished? I know The Mantra <a
 href="file:///Data/CLDP/LG/2003/02/temp/okopnik.html#1">[1]</a>, of
course, but I'd like to go on if possible; my users need me, and I know
of The Dark Powers that slaver to descend upon their innocent souls
without a sysadmin to protect them." </p>
<p>Woomert nodded, recognizing the weary old warrior's words as
completely true; he, too, had encountered and battled The Dark Ones,
creatures that would completely unhinge the minds of the users if they
were freed for even a moment, and knew of the valiant SysAdmin's Guild
(<a href="http://sage.org">http://sage.org</a>) which had sworn to
protect the innocent (even though it was often protection from
themselves, via the application of the mystic and holy LART <a
 href="file:///Data/CLDP/LG/2003/02/temp/okopnik.html#2">[2]</a>). </p>
<p> -- "Resolv, I'm very happy to say that there is indeed a solution
to the problem. I'm sure that you've done your research on the
available tools, and have heard of '<tt>atool</tt>', an archive manager
by Oskar Liljeblad..." </p>
<p>At Resolv's nod, he went on. </p>
<p>"All right; then you also know that it will handle all of the above
archive formats and more. Despite the fact that it's written in Perl,
we're not going to use any of its code in your script - that would be a
wasteful duplication of effort. Instead, we're simply going to use '<tt>acat'</tt>,
one of <tt>'atool'</tt>s utilities, as an external filter - a
conditional one. All we have to do is insert it right at the beginning
of your script, like so: </p>
<pre><hr width="100%">#!/usr/bin/perl -w<br># Created by Resolv Dot Conf on Pungenday, Chaos 43, 3166 YOLD<br><br><b>@ARGV = map { /\.(gz|tgz|zip|bz2|rar|Z)$/ ? "acat $_ '*' 2&gt;/dev/null|" : $_ } @ARGV;<br><br></b># Rest of script follows</pre>
<pre>...<br><br><hr width="100%"></pre>
"Perl will take care of the appropriate magic - and that will take care
of the problem."
<p>The sysadmin was on his feet in a moment, fervently shaking
Woomert's hand. </p>
<p> -- "Mr. Foonly, I don't know how to thank you. You've saved...
well, I won't speak of that, but I want you to know that you've always
got a friend wherever I happen to be. Wait until they see <i>this</i>!...
Uh, just to make sure I understand - what <b>is</b> it? How does it
work?" </p>
<p>Woomert glanced over at Frink, who also seemed to be on the edge of
his seat, eager for the explanation. </p>
<p> -- "What do you think, Frink - can you handle this one? I've only
used one function and one operator; the rest of it happened
automagically, simply because of the way that Perl deals with files on
the command line." </p>
<p>Frink turned a little pink, and chewed his thumb as he always did
when he was nervous. </p>
<p> -- "Well, Woomert... I know you told me to study the 'map'
function, but it was pretty deep; I got lost early on, and then there
was this new movie out..." </p>
<p>Woomert smiled and shook his head. </p>
<p> -- "All right, then. 'map', as per the info from '<tt>perldoc -f map</tt>',
evaluates the specified expression or block of expressions for each
element of a list - sort of like a 'for' loop, but much shorter and
more convenient in many cases. I also used the ternary conditional
operator ('<tt>?:</tt>') which works somewhat like an "if-then-else"
construct: </p>
<pre><hr width="100%"># Ternary conditional op - sets $a to 5 if $b is true, to 10 otherwise<br>$a = $b ? 5 : 10;<br><br># "if-then-else" construct - same action<br>if ( $b ){<br>        $a = 5;<br>}<br>else {<br>        $a = 10;<br>}<br><hr
 width="100%"></pre>
"Both of the above do the same thing, but again, the first method is
shorter and often more convenient. Examining the script one step at a
time, what I have done is test each of the elements in @ARGV, which
initially contains everything on the command line that follows the
script name, against the following regular expression:
<p><tt>/\.(gz|tgz|zip|bz2|rar|Z)$/</tt> </p>
<p>This will match any filename that ends in a period (a literal dot)
followed by any of the specified extensions. </p>
<p>Now, if the filename <i>doesn't</i> match the regex, the ternary
operator returns the part after the colon, '<tt>$_</tt>' - which simply
contains the original filename. Perl then processes the filename as it
normally does the ones contained in @ARGV: it opens a filehandle to that
file and makes its contents available within the script. In fact, there
are a number of ways to access the data once that's done; read up on the
diamond operator ('<tt>&lt;&gt;</tt>') , the STDIN filehandle, and the
ARGV filehandle (note the similarity <i>and</i> the difference, Frink!)
for information on some of the many available methods of doing file I/O
in Perl." </p>
<p>"On the other hand, if the current element <i>does</i> match, the
ternary operator will return the code before the colon, in this case </p>
<p><tt>"acat $_ '*' 2&gt;/dev/null|"</tt> </p>
<p>Perl will then execute the above command for the current filename.
The syntax may seem a little odd, but it's what '<tt>acat</tt>' (or,
more to the point, the archive utilities that it uses) requires to
process the files and ignore the error messages. Note that the command
ends in '|', the pipe symbol; what happens here is much like doing a
pipe within the shell. The command will be executed, the output will be
placed in a memory buffer, and the contents of that buffer will become
available on the filehandle that Perl would normally have opened for
that file - presto, pure magic! <a
 href="file:///Data/CLDP/LG/2003/02/temp/okopnik.html#3">[3]</a>" </p>
<p>"So, to break it all out in long form, here's what I did: </p>
<pre><hr width="100%">@ARGV = <br>        map {                                       # Use the BLOCK syntax of 'map'<br>                if ( /\.(gz|tgz|zip|bz2|rar|Z)$/ ){     # Look for archive extensions<br>                        "acat $_ '*' 2&gt;/dev/null|"; # Uncompress/pipe out the contents<br>                }<br>                else {<br>                        $_;                         # Otherwise, return original name<br>                }<br>        } @ARGV;                                    # This is the list to "walk" over<br><br><hr
 width="100%"></pre>
"Perl handles it from that point on. Once you pass it something useful
on the command line or standard input, it knows just what to do. In
fact," he glanced sternly over at Frink,  who once again looked
abashed, "studying '<tt>perldoc perlopentut</tt>' is something I
recommend to anyone who wants to understand how Perl does I/O. This
includes files, pipes, forking child processes, building filters,
dealing with binary files, duplicating file handles, the
single-argument version of 'open', and many other things. In some ways,
this could be called the most important document that comes with Perl.
Taking a look at '<tt>perldoc perlipc</tt>' as a follow-up would be a
good idea as well - it deals with a number of related issues, including
opening safe (low privilege) pipes to possibly insecure processes,
something that can become very important in a hurry."
<p> -- "Now, Resolv, I believe that you have a bright new future
stretching out ahead of you; your problem will be solved, your
management will be pleased, and your users will remain safe from Those
Outside The Pale. If you would care to join us in a little celebration,
I've just finished boiling a Spotted Dog, and - oh. Where did he go?...
It's a very fine English pudding with currants, after all. Well, I
suppose he wanted to implement that change as soon as possible..." </p>
</div>
<div>
<h2>附註</h2>
</div>
<div>
<p><a name="1"></a>[1] "Down, Not Across." For those who need
additional clues on the grim meaning of The Sysadmin Mantra, search the
archives of <b>alt.sysadmin.recovery</b> at <a
 href="http://groups.google.com">&lt;http://groups.google.com&gt;</a>,
and all will become clear. If it does not, then you weren't meant to
know. :) </p>
<p><a name="2"></a>[2] From The Jargon File: </p>
<pre>  Luser Attitude Readjustment Tool. ... The LART classic is a 2x4 or<br>  other large billet of wood usable as a club, to be applied upside the<br>  head of spammers and other people who cause sysadmins more grief than<br>  just naturally goes with the job. Perennial debates rage on<br>  alt.sysadmin.recovery over what constitutes the truly effective LART;<br>  knobkerries, semiautomatic weapons, flamethrowers, and tactical nukes<br>  all have their partisans. Compare {clue-by-four}.<br></pre>
<p><a name="3"></a>[3] See "perldoc perlopentut" for a tutorial on
opening files, the 'magic' in @ARGV, and even "Dispelling the Dweomer"
for those who have seen too much magic already. :)</p>
</div>
<div>
<h2>作者介紹</h2>
</div>
<div>
<p> Ben is a Contributing Editor for Linux Gazette and a member of The
Answer Gang.<!-- *** BEGIN bio *** --> </p>
<p> <img alt="picture" src="../gx/2002/tagbio/ben-okopnik.jpg"
 style="width: 199px; height: 200px;" align="left" hspace="10"
 vspace="10" title=""> <em> Ben was born in Moscow, Russia in 1962. He
became interested in electricity at age six--promptly demonstrating it
by sticking a fork into a socket and starting a fire--and has been
falling down technological mineshafts ever since. He has been working
with computers since the Elder Days, when they had to be built by
soldering parts onto printed circuit boards and programs had to fit
into 4k of memory.  He would gladly pay good money to any psychologist
who can cure him of the resulting nightmares. </em></p>
<p><em>Ben's subsequent experiences include creating software in nearly
a dozen languages, network and database maintenance during the approach
of a hurricane, and writing articles for publications ranging from
sailing magazines to technological journals. Having recently completed
a seven-year Atlantic/Caribbean cruise under sail, he is currently
docked in Baltimore, MD, where he works as a technical instructor for
Sun Microsystems. </em></p>
<em>Ben has been working with Linux since 1997, and credits it with his
complete loss of interest in waging nuclear warfare on parts of the
Pacific Northwest. </em></div>
<div>
<h2>版權宣告</h2>
</div>
<div>
<p> Copyright © 2003, Ben Okopnik. Copying license <a
 href="file:///Data/CLDP/LG/2003/02/copying.html">http://www.linuxgazette.com/copying.html</a><br>
Published in Issue 87 of <i>Linux Gazette</i>, February 2003</p>
</div>
</div>
<hr>
<p class="BarTop"><a href="../../../index.html" title="連到首頁"
 hreflang="zh-TW" accesskey="H">首頁(H)</a>｜<a href="../../../howto/"
 title="連到和 HOWTO  相關資訊" hreflang="zh-TW" accesskey="T">HOWTO(T)</a>｜<a
 href="../../../guide/" title="連到和指南相關的資訊" hreflang="zh-TW"
 accesskey="G">指南(G)</a>｜<a href="../../../FAQ/" title="連到和問答集相關的資訊"
 hreflang="zh-TW" accesskey="F">FAQ(F)</a>｜<a href="../../../man/"
 title="連到和手冊頁有關的資訊" hreflang="zh-TW" accesskey="M">手冊頁(M)</a>｜<a
 href="../../index.html" title="Linux電子報為一個月發行一期的雜誌" hreflang="zh-TW"
 accesskey="L">Linux電子報(L)</a>｜<a href="../../../LF/"
 title="LinuxFocus 為兩個月發行一期的雜誌" hreflang="zh-TW" accesskey="S">LinuxFocus(S)</a></p>
<hr>
</body>
</html>
