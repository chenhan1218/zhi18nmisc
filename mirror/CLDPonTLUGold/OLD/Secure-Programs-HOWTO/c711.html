<HTML
><HEAD
><TITLE
>小心對其它資源的調用出口</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.54"><LINK
REL="HOME"
TITLE="Linux和Unix安全編程HOWTO"
HREF="book1.html"><LINK
REL="PREVIOUS"
TITLE="自我限制資源"
HREF="x708.html"><LINK
REL="NEXT"
TITLE="檢查系統調用的所有返回值"
HREF="x741.html"></HEAD
><BODY
CLASS="CHAPTER"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Linux和Unix安全編程HOWTO</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x708.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x741.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="AEN711"
>Chapter 7. 小心對其它資源的調用出口</A
></H1
><TABLE
BORDER="0"
WIDTH="100%"
CELLSPACING="0"
CELLPADDING="0"
CLASS="EPIGRAPH"
><TR
><TD
WIDTH="45%"
>&nbsp;</TD
><TD
WIDTH="45%"
ALIGN="LEFT"
VALIGN="TOP"
><I
><P
><I
>Do not put your trust in princes, in mortal men, who cannot save.</I
></P
></I
></TD
></TR
><TR
><TD
WIDTH="45%"
>&nbsp;</TD
><TD
WIDTH="45%"
ALIGN="RIGHT"
VALIGN="TOP"
><I
><SPAN
CLASS="ATTRIBUTION"
>Psalms 146:3 (NIV)</SPAN
></I
></TD
></TR
></TABLE
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
><A
HREF="c711.html#AEN716"
>限制調用出口為合法值</A
></DT
><DT
><A
HREF="x741.html"
>檢查系統調用的所有返回值</A
></DT
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="AEN716"
>限制調用出口為合法值</A
></H1
><P
>要保証調用其它程序的出口只允許每個參數的合法而且期望的值。聽起來不難，但實現起來就難得多了，因為有很多庫調用或命令會以潛在的令人驚異的方式調用低級例程。例如，若干popen(3)和system(3)一類的系統調用通過調用命令shell來實現，也就是說，它們會受到shell轉義字符的影響。同樣，execlp(3)和execvp(3)也可能會調用shell。很多指南建議在產生一個進程時完全避免使用popen(3)、system(3)、execlp(3)和execvp(3)，直接用C中的execve(3)[Galvin 1998b]。至少應該避免在可以使用execve(3)時使用system(3)﹔因為system(3)使用shell來擴展字符，對于惡作劇者來說system(3)會提供更多機會。Perl和shell的backtick（`）也以同樣的方式調用命令shell﹔參見Perl一節。</P
><P
>這個問題最令人頭疼的例子就是shell轉義字符。標准的類Unix命令shell（存儲在/bin/sh）對許多字符有特別的解釋。如果這些字符被傳遞給shell，那么除非被忽略，都將使用它們的特殊解釋﹔這一事實可被用來破壞程序。按照WWW安全FAQ[Stein 1999, Q37]，這些轉義字符是：

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>&#38; ; ` ' \ " | * ? ~ &#60; &#62; ^ ( ) [ ] { } $ \n \r</PRE
></TD
></TR
></TABLE
></P
><P
>不幸的是，這并非實際存在的所有轉義字符。下面是可能出問題是一些其它字符：
<P
></P
><UL
><LI
><P
>“!” 在表達式里意味著“否”（就象在C語言里一樣）﹔如果程序的返回值被檢測，預先考慮“!”會欺騙腳本在某些事情已經成功時以為它失敗了，或是相反。在某些shell里，“ !”會訪問命令的過去，這會導致真正的問題。在bash里，只有交互模式會出問題，但tcsh（某些Linux發行版里的csh的復制形式）甚至在腳本里都使用“!”。新的bash看來也用“ !”來訪問命令的過去 -- 但可能只用于交互模式。</P
></LI
><LI
><P
>“#”是注釋字符，隨后的文本被忽略。</P
></LI
><LI
><P
>“-”會被誤解為后面是一個選項（或者象“--”一樣禁用其它選項）。甚至當它位于文件名的中間，或者前面存在被shell認為是空格的字符，都可能會出問題。</P
></LI
><LI
><P
>“ ”（空格）和其它空格字符會把某個“單獨的”文件名變成多個參數。</P
></LI
><LI
><P
>其它控制字符（特別是NIL）會在某些shell的實現上產生問題。</P
></LI
><LI
><P
>按照應用的情況，甚至可以想象“.”（“在當前shell下運行”）和“=”（設置變量）都是令人擔心的字符，而且目前找到的例子表明這些問題會帶來更嚴重的安全問題。</P
></LI
></UL
>&#13;</P
><P
>忘記其中的某個字符會導致災難性后果，例如，許多程序把反斜杠作為轉義字符加以忽略[rfp 1999]。像在“証實輸入”一節所討論的那樣，一個推荐方案是至少在輸入時立刻忽略掉所有這些字符。同樣，目前最好的解決方案是識別出希望允許的字符，并且只使用這些字符。</P
><P
>許多程序有執行“額外”操作的“逃逸”代碼﹔要確保它們沒有被包括在內（除非希望它們出現在消息里）。例如，許多面向行命令的郵件程序（如mail和mailx）使用代字符（~）作為逃逸字符，可以用來發送許多命令。結果，像“mail admin &#60; file-from-user”這樣看起來清白的命令就會被用來執行任意程序。vi和emacs一類的交互程序有“逃逸”機制，通常允許用戶使用過程中執行任意的shell命令。應該無論如何都檢查調用程序的文檔來尋找逃逸機制。</P
><P
>避免逃逸代碼的問題甚至涉及到底層硬件部件及其仿真器。大多數調制解調器實現了所謂的“Hayes”命令集，用“+++”序列、一個延遲再加上“+++”來強迫調制解調器切換模式（并把后面的文本作為命令解釋）。這可以被用來實現拒絕服務攻擊，甚或強迫用戶與另一個人相連接。許多“終端”接口實現了VT100一類早已過時的老物理終端的逃逸代碼。比如這些代碼可以用來改變終端接口的字體顏色。盡管如此，不要允許直接向終端屏幕發送任意的不可信數據，因為某些代碼會導致嚴重問題。在某些系統上可以重新映射按鍵﹔在若干系統上甚至可以發送代碼來清除屏幕、顯示一組希望受害者運行的命令以及把這些設置發“回去”（強迫受害者運行攻擊者選擇的命令）。</P
><P
>與之相關的一個問題是NIL字符（字符0）可能會有些出人意料的后果。大多數C和C++函數假設該字符標識字符串的結束，但其它語言（如Perl和Ada95）中的字符串處理例程可以處理包含NIL的字符串。由于很多庫和內核調用使用的是C語言規范，結果就是被檢查的內容并非實際所用到的[rfp 1999]。</P
><P
>在調用其它程序或引用某個文件時，應該總是指定其完整路徑（如<TT
CLASS="FILENAME"
>/usr/bin/sort</TT
>）。對于程序調用，即使PATH值設置不正確，這也會排除調用“錯誤”的命令可能引起的錯誤。對于引用其它文件，這會減少“錯誤”的起始目錄所帶來的問題。</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x708.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="book1.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x741.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>自我限制資源</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>檢查系統調用的所有返回值</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>