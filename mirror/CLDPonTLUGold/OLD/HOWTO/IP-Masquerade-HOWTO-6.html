<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>Linux IP Masquerade HOWTO: Other IP Masquerade Issues and Software Support </TITLE>
 <LINK HREF="IP-Masquerade-HOWTO-7.html" REL=next>
 <LINK HREF="IP-Masquerade-HOWTO-5.html" REL=previous>
 <LINK HREF="IP-Masquerade-HOWTO.html#toc6" REL=contents>
<SCRIPT src="../menu.js"> function BeginPage() {} function EndPage() {} </SCRIPT> </HEAD> <BODY bgcolor=#EEEEFF MARGINHEIGHT=0 MARGINWIDTH=0> <SCRIPT>BeginPage(1, 8, 1);</SCRIPT>
<A HREF="IP-Masquerade-HOWTO-7.html"><IMG SRC="../img/next.gif" ALT="Next"></A>
<A HREF="IP-Masquerade-HOWTO-5.html"><IMG SRC="../img/prev.gif" ALT="Previous"></A>
<A HREF="IP-Masquerade-HOWTO.html#toc6"><IMG SRC="../img/toc.gif" ALT="Contents"></A>
<HR>
<H2><A NAME="s6">6. Other IP Masquerade Issues and Software Support </A></H2>

<P>
<P>
<H2><A NAME="ss6.1">6.1 Problems with IP Masquerade </A>
</H2>

<P>Some TCP/IP application protocols will not currently work with Linux IP Masquerading because they either assume things about port numbers or encode TCP/IP addresses and/or port numbers in their data stream. These latter protocols need specific proxies or IP MASQ modules built into the masquerading code to make them work.
<P>
<P>
<H2><A NAME="ss6.2">6.2 Incoming services </A>
</H2>

<P>By default, Linux IP Masquerading cannot handle incoming services at all but there are a few
ways of allowing them.
<P>If you do not require high levels of security then you can simply forward or redirect IP ports.  There are various ways of doing this though the most stable method is to use IPPORTFW.  For more information, please see the 
<A HREF="#Forwarders">Forwarders</A>
 section. 
<P>If you wish to have some level of authorization on incoming connections then you will need to either configure TCP-wrappers or Xinetd to then allow only specific IP addresses through.  The TIS Firewall Toolkit is a good place to look for tools and information.
<P>More details on incoming security can be found in the 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS</A> document and at 
<A HREF="http://ipmasq.cjb.net">IP Masquerade Resource</A>.
<P>
<A NAME="Supported Client Software"></A> <P>
<P>
<P>
<H2><A NAME="ss6.3">6.3 Supported Client Software and Other Setup Notes</A>
</H2>

<P>
<P>
<A NAME="Clients"></A> <P>
<BLOCKQUOTE>
<B>** The 
<A HREF="http://www.tsmservices.com/masq">Linux Masquerade Application list</A> has a lot of good information regarding applications that work through Linux IP masquerading.  This site was recently taken over by Steve Grevemeyer who implimented it with a full database backend.  Its a great resource!  </B>
</BLOCKQUOTE>
<P>Generally, any application that uses standard TCP and UDP should work.  If you have any suggestion, hints, etc., please see the 
<A HREF="http://ipmasq.cjb.net/">IP Masquerade Resource</A> for more details.
<P>
<H3>Network Clients that -Work- with IP Masquerade</H3>

<P>General Clients:
<P>
<DL>
<DT><B>Archie</B><DD><P>all supported platforms, file searching client (not all archie clients are supported) 
<P>
<DT><B>FTP</B><DD><P>all supported platforms, with the <EM>ip_masq_ftp.o</EM> kernel module for active FTP connections.
<P>
<DT><B>Gopher client</B><DD><P>all supported platforms
<P>
<DT><B>HTTP</B><DD><P>all supported platforms, WWW surfing 
<P>
<DT><B>IRC</B><DD><P>all IRC clients on various supported platforms, DCC is supported via the <EM>ip_masq_irc.o</EM> module
<P>
<DT><B>NNTP (USENET)</B><DD><P>all supported platforms, USENET news client 
<P>
<DT><B>PING</B><DD><P>all platforms, with ICMP Masquerading kernel option
<P>
<DT><B>POP3</B><DD><P>all supported platforms, email clients 
<P>
<DT><B>SSH</B><DD><P>all supported platforms, Secure TELNET/FTP clients 
<P>
<DT><B>SMTP</B><DD><P>all supported platforms, email servers like Sendmail, Qmail, PostFix, etc.
<P>
<DT><B>TELNET</B><DD><P>all supported platforms, remote session
<P>
<DT><B>TRACEROUTE</B><DD><P>UNIX and Windows based platforms , some variations may not work
<P>
<DT><B>VRML</B><DD><P>Windows(possibly all supported platforms), virtual reality surfing 
<P>
<DT><B>WAIS client</B><DD><P>all supported platforms
</DL>
<P>
<P>Multimedia and Communication Clients:
<P>
<DL>
<DT><B>All H.323 programs</B><DD><P>- MS Netmeeting, Intel Internet Phone Beta , and other H.323 applications - There are now two solutions to get this to work through IPMASQed connections:
<P>There is a stable BETA module available on the 
<A HREF="http://ipmasq.cjb.net">MASQ WWW site</A> or at 
<A HREF="http://www.coritel.it/projects/sofia/nat.html">http://www.coritel.it/projects/sofia/nat.html</A> to work with Microsoft Netmeeting v3.x code on 2.2.x kernels.  There is also another module version on the MASQ WWW site specifically for Netmeeting 2.x with 2.0.x kernels but it doesn't support Netmeeting v3.x.  
<P>Another commercial solution is the 
<A HREF="http://www.equival.com.au/phonepatch/index.html">Equivalence's PhonePatch</A> H.323 gateway.
<P>
<DT><B>Alpha Worlds</B><DD><P>Windows, Client-Server 3D chat program  
<P>
<DT><B>CU-SeeMe</B><DD><P>all supported platforms, with the <EM>ip_masq_cuseeme</EM> module loaded, please see the 
<A HREF="#CuSeeme">CuSeeme</A>
 section for more details.
<P>
<DT><B>ICQ</B><DD><P>all supported clients.  Requires the Linux kernel to be compiled with IPPORTFW support and ICQ is configured to be behind a NON-SOCKS proxy.  A full description of this configuration is in the 
<A HREF="#ICQ">ICQ</A>
 section.
<P>
<DT><B>Internet Phone 3.2</B><DD><P>Windows, Peer-to-peer audio communications, people can reach you only if you initiate the call, but people cannot call you without a specific port forwarding setup.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details. 
<P>
<DT><B>Internet Wave Player</B><DD><P>Windows, network streaming audio 
<P>
<DT><B>Powwow</B><DD><P>Windows, Peer-to-peer Text audio whiteboard communications, people can reach you only if you initiate the call, but people cannot call you without a specific port forwarding setup.  See the 
<A HREF="#Forwarders">Forwarders</A>
 se
ction for more details. 
<P>
<DT><B>Real Audio Player</B><DD><P>Windows, network streaming audio, higher quality available with the <EM>ip_masq_raudio</EM> UDP module 
<P>
<DT><B>True Speech Player 1.1b</B><DD><P>Windows, network streaming audio 
<P>
<DT><B>VDOLive</B><DD><P>Windows, with the <EM>ip_masq_vdolive</EM> patch
<P>
<DT><B>Worlds Chat 0.9a</B><DD><P>Windows, Client-Server 3D chat program  
</DL>
<P>
<A NAME="Game-Clients"></A> <P>
<P>Games - See the 
<A HREF="#LooseUDP">LooseUDP</A>
 section for more details on the LooseUDP patch
<P>
<DL>
<DT><B>Battle.net</B><DD><P>Works but requires TCP ports 116 and 118 and UDP port 6112 IPPORTFWed to the game machine.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.  Please note that FSGS and Bnetd servers still require IPPORTFW since they haven't been re-written to be NAT-friendly.
<P>
<DT><B>BattleZone 1.4</B><DD><P>Works with LooseUDP patch and new NAT-friendly 
<A HREF="http://us4.alink.activision.com/tmp/nat/">.DLLs from Activision</A><P>
<DT><B>Dark Reign 1.4</B><DD><P>Works with LooseUDP patch or requires TCP ports 116 and 118 and UDP port 6112 IPPORTFWed to the game machine.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<DT><B>Diablo</B><DD><P>Works with LooseUDP patch or requires TCP ports 116 and 118 and UDP port 6112 IPPORTFWed to the game machine.  Newer versions of Diablo use only TCP port 6112 and UDP port 6112.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<DT><B>Heavy Gear 2</B><DD><P>Works with LooseUDP patch or requires TCP ports 116 and 118 and UDP port 6112 IPPORTFWed to the game machine.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<DT><B>Quake I/II/III</B><DD><P>Works right out of the box but requires the <EM>ip_masq_quake</EM> module if there are more than one Quake I/II/III player behind a MASQ box.  Also, this module only supports Quake I and QuakeWorld by default.  If you need to support Quake II or non-default server ports, please see the module install section of the 
<A HREF="IP-Masquerade-HOWTO-3.html#rc.firewall-2.0.x">rc.firewall-2.0.x</A>
 and 
<A HREF="IP-Masquerade-HOWTO-3.html#rc.firewall-2.2.x">rc.firewall-2.2.x</A>
 rulesets.
<P>
<DT><B>StarCraft</B><DD><P>Works with the LooseUDP patch and IPPORTFWing TCP and UDP ports 6112 to the internal MASQed game machine.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<DT><B>WorldCraft</B><DD><P>Works with LooseUDP patch
</DL>
<P>
<P>Other Clients:
<P>
<DL>
<DT><B>Linux net-acct package</B><DD><P>Linux, network administration-account package
<P>
<DT><B>NCSA Telnet 2.3.08</B><DD><P>DOS, a suite containing telnet, ftp, ping, etc.
<P>
<DT><B>PC-anywhere for Windows </B><DD><P>MS-Windows, Remotely controls a PC over TCP/IP, only work if it is a client but not a host without a specific port forwarding setup.  See the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<DT><B>Socket Watch</B><DD><P>uses NTP - network time protocol
</DL>
<P>
<H3>Clients that do not have full support in IP MASQ:</H3>

<P> 
<DL>
<DT><B>Intel Streaming Media Viewer Beta 1</B><DD><P>Cannot connect to server
<P>
<DT><B>Netscape CoolTalk</B><DD><P>Cannot connect to opposite side
<P>
<DT><B>WebPhone</B><DD><P>Cannot work at present (it makes invalid assumptions about addresses).
<P>
</DL>
<P>
<P>
<H2><A NAME="ss6.4">6.4 Stronger IP Firewall (IPFWADM) Rulesets</A>
</H2>

<P>
<P>
<A NAME="Strong-IPFWADM-Rulesets"></A> <P>This section provides a more in-depth guide on using the 2.0.x firewall tool, IPFWADM.  See below for IPCHAINS rulesets
<P>This example is for a firewall/masquerade system behind a PPP link with a static PPP address (dynamic PPP instructions are included but disabled).  The trusted interface is 192.168.0.1 and the PPP interface IP address has been changed to protect the guilty :).  I have listed each incoming and outgoing interface individually to catch IP spoofing as well as stuffed routing and/or masquerading. Anything not explicitly allowed is <B>FORBIDDEN</B> (well.. rejected actually).  If your IP MASQ box breaks after implementing this rc.firewall script, be sure that you edited it for your configuration and check your /var/log/messages or /var/adm/messages SYSLOG file for any firewall errors.
<P>For more comprehensive examples of a strong IP Masqueraded IPFWADM rulesets for PPP, Cablemodem users, etc.,
please see 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> and 
<A HREF="http://www.greatcircle.com/">GreatCircle's Firewall WWW page</A><P><B>NOTE:</B> If you get a dynamically assigned TCP/IP address from your ISP (PPP, ADSL, Cablemodems, etc.), you <B>CANNOT load</B> this strong ruleset upon boot.  You will either need to reload this firewall ruleset EVERY TIME you get a new IP address or make your /etc/rc.d/rc.firewall ruleset more intelligent.  To do this for PPP users, carefully read and un-comment out the properly lines in the "Dynamic PPP IP fetch" section below.   You can also find more details in the 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> doc for more details on Strong rulesets and Dynamic IP addresses.  
<P><B>Please also be aware that there are several GUI Firewall creation tools available as well.  Please see the 
<A HREF="IP-Masquerade-HOWTO-7.html#FAQ">FAQ</A>
 section for full details.</B>
<P>Lastly, if you are using a STATIC PPP IP address, change the "ppp_ip="your.static.PPP.address"" line to reflect your address.
<P>----------------------------------------------------------------
<P>
<A NAME="stronger-rc.firewall-2.0.x"></A> <P>
<PRE>
#!/bin/sh
#
# /etc/rc.d/rc.firewall: An example of a semi-STRONG IPFWADM firewall ruleset
#

PATH=/sbin:/bin:/usr/sbin:/usr/bin

# testing, wait a bit then clear all firewall rules.
# uncomment following lines if you want the firewall to automatically
# disable after 10 minutes.
# (sleep 600; \
# ipfwadm -I -f; \
# ipfwadm -I -p accept; \
# ipfwadm -O -f; \
# ipfwadm -O -p accept; \
# ipfwadm -F -f; \
# ipfwadm -F -p accept; \
# ) &amp;

# Load all required IP MASQ modules
#
#   NOTE:  Only load the IP MASQ modules you need.  All current IP MASQ modules
#          are shown below but are commented from loading.

# Needed to initially load modules
#
/sbin/depmod -a

# Supports the proper masquerading of FTP file transfers using the PORT method
#
/sbin/modprobe ip_masq_ftp

# Supports the masquerading of RealAudio over UDP.  Without this module,
#       RealAudio WILL function but in TCP mode.  This can cause a reduction
#       in sound quality
#
#/sbin/modprobe ip_masq_raudio

# Supports the masquerading of IRC DCC file transfers
#
#/sbin/modprobe ip_masq_irc


# Supports the masquerading of Quake and QuakeWorld by default.  This modules is
#   for for multiple users behind the Linux MASQ server.  If you are going to 
#   play Quake I, II, and III, use the second example.
#
#   NOTE:  If you get ERRORs loading the QUAKE module, you are running an old
#   -----  kernel that has bugs in it.  Please upgrade to the newest kernel.
#
#Quake I / QuakeWorld (ports 26000 and 27000)
#/sbin/modprobe ip_masq_quake
#
#Quake I/II/III / QuakeWorld (ports 26000, 27000, 27910, 27960)
#/sbin/modprobe ip_masq_quake 26000,27000,27910,27960


# Supports the masquerading of the CuSeeme video conferencing software
#
#/sbin/modprobe ip_masq_cuseeme

#Supports the masquerading of the VDO-live video conferencing software
#
#/sbin/modprobe ip_masq_vdolive


#CRITICAL:  Enable IP forwarding since it is disabled by default since
#
#           Redhat Users:  you may try changing the options in /etc/sysconfig/network from:
#
#                       FORWARD_IPV4=false
#                             to
#                       FORWARD_IPV4=true
#
echo "1" > /proc/sys/net/ipv4/ip_forward


#CRITICAL:  Enable automatic IP defragmenting since it is disabled by default 
#           in 2.2.x kernels
#
#           This used to be a compile-time option but the behavior was changed 
#           in 2.2.12
#
echo "1" > /proc/sys/net/ipv4/ip_always_defrag


# Dynamic IP users:
#
#   If you get your IP address dynamically from SLIP, PPP, or DHCP, enable this 
#   following option.  This enables dynamic-ip address hacking in IP MASQ, 
#   making the life with Diald and similar programs much easier.
#
#echo "1" > /proc/sys/net/ipv4/ip_dynaddr


# Specify your Static IP address here.  
#
#   If you have a DYNAMIC IP address, you need to make this ruleset understand 
#   your IP address everytime you get a new IP.  To do this, enable the 
#   following one-line script.  (Please note that the different single and 
#   double quote characters MATTER).  
#
#
#   DHCP users:  
#   -----------
#   If you get your TCP/IP address via DHCP, **you will need ** to enable the 
#   #ed out command below underneath the PPP section AND replace the word 
#   "ppp0" with the name of your EXTERNAL Internet connection (eth0, eth1, 
#   etc).  It should be also noted that the DHCP server can change IP 
#   addresses on you.  To fix this, users should configure their DHCP client 
#   to re-run the firewall ruleset everytime the DHCP lease is renewed.  
#
#     NOTE #1:  Some DHCP clients like the older version of "pump" (the newer
#               versions have been fixed) did NOT have the ability to run 
#               scripts after a lease-renew.  Because of this, you need to 
#               replace it with something like "dhcpcd" or "dhclient".
#
#     NOTE #2:  The syntax for "dhcpcd" has changed in recent versions.
#
#               Older versions used syntax like:
#                         dhcpcd -c /etc/rc.d/rc.firewall eth0
#
#               Newer versions use syntax like:
#                         dhcpcd eth0 /etc/rc.d/rc.firewall
#
#     NOTE #3:  For Pump users, put the following line in /etc/pump.conf:
#
#                   script /etc/rc.d/rc.firewall
#
#   PPP users:  
#   ----------
#   If you aren't already aware, the /etc/ppp/ip-up script is always run when 
#   a PPP connection comes up.  Because of this, we can make the ruleset go 
#   and get the new PPP IP address and update the strong firewall ruleset.
#
#   If the /etc/ppp/ip-up file already exists, you should edit it and add a line
#   containing "/etc/rc.d/rc.firewall" near the end of the file.
#
#   If you don't already have a /etc/ppp/ip-up sccript, you need to create the 
#   following link to run the /etc/rc.d/rc.firewall script.
#
#       ln -s /etc/rc.d/rc.firewall /etc/ppp/ip-up
#
#   * You then want to enable the #ed out shell command below *
#
#  
# PPP and DHCP Users: 
# -------------------
# Remove the # on the line below and place a # in front of the line after that.
#
#ppp_ip="`/sbin/ifconfig ppp0 | grep 'inet addr' | awk '{print $2}' | sed -e 's/.*://'`"
#
ppp_ip="your.static.PPP.address"


# MASQ timeouts 
#
#   2 hrs timeout for TCP session timeouts
#  10 sec timeout for traffic after the TCP/IP "FIN" packet is received
#  60 sec timeout for UDP traffic (MASQ'ed ICQ users must enable a 30sec firewall timeout in ICQ itself) 
#
/sbin/ipfwadm -M -s 7200 10 60


#############################################################################
# Incoming, flush and set default policy of reject. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
/sbin/ipfwadm -I -f
/sbin/ipfwadm -I -p reject

# local interface, local machines, going anywhere is valid
#
/sbin/ipfwadm -I -a accept -V 192.168.0.1 -S 192.168.0.0/24 -D 0.0.0.0/0

# remote interface, claiming to be local machines, IP spoofing, get lost
#
/sbin/ipfwadm -I -a reject -V $ppp_ip -S 192.168.0.0/24 -D 0.0.0.0/0 -o

# remote interface, any source, going to permanent PPP address is valid
#
/sbin/ipfwadm -I -a accept -V $ppp_ip -S 0.0.0.0/0 -D $ppp_ip/32

# loopback interface is valid.
#
/sbin/ipfwadm -I -a accept -V 127.0.0.1 -S 0.0.0.0/0 -D 0.0.0.0/0

# catch all rule, all other incoming is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
/sbin/ipfwadm -I -a reject -S 0.0.0.0/0 -D 0.0.0.0/0 -o


#############################################################################
# Outgoing, flush and set default policy of reject. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
/sbin/ipfwadm -O -f
/sbin/ipfwadm -O -p reject

# local interface, any source going to local net is valid
#
/sbin/ipfwadm -O -a accept -V 192.168.0.1 -S 0.0.0.0/0 -D 192.168.0.0/24

# outgoing to local net on remote interface, stuffed routing, deny
#
/sbin/ipfwadm -O -a reject -V $ppp_ip -S 0.0.0.0/0 -D 192.168.0.0/24 -o

# outgoing from local net on remote interface, stuffed masquerading, deny
#
/sbin/ipfwadm -O -a reject -V $ppp_ip -S 192.168.0.0/24 -D 0.0.0.0/0 -o

# outgoing from local net on remote interface, stuffed masquerading, deny
#
/sbin/ipfwadm -O -a reject -V $ppp_ip -S 0.0.0.0/0 -D 192.168.0.0/24 -o

# anything else outgoing on remote interface is valid
#
/sbin/ipfwadm -O -a accept -V $ppp_ip -S $ppp_ip/32 -D 0.0.0.0/0

# loopback interface is valid.
#
/sbin/ipfwadm -O -a accept -V 127.0.0.1 -S 0.0.0.0/0 -D 0.0.0.0/0

# catch all rule, all other outgoing is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
/sbin/ipfwadm -O -a reject -S 0.0.0.0/0 -D 0.0.0.0/0 -o


#############################################################################
# Forwarding, flush and set default policy of deny. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
/sbin/ipfwadm -F -f
/sbin/ipfwadm -F -p deny

# Masquerade from local net on local interface to anywhere.
#
/sbin/ipfwadm -F -a masquerade -W ppp0 -S 192.168.0.0/24 -D 0.0.0.0/0
#
# catch all rule, all other forwarding is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
/sbin/ipfwadm -F -a reject -S 0.0.0.0/0 -D 0.0.0.0/0 -o

#End of file.
</PRE>
<P>
<P>
<P>With IPFWADM, you can block traffic to a particular site using the -I, -O or -F rules.  Remember that the set of rules are scanned top to bottom and "-a" tells IPFWADM to "append" this new rule to the existing set of rules.  So with this in mind, any specific restrictions need to come before global rules. For example:
<P>Using -I (input ) rules:
<P>Probably the fastest and most efficient method to block traffic but it only stops the MASQed machines and NOT the the firewall machine itself. Of course you might want to allow that combination.
<P>Anyway, to block 204.50.10.13:
<P>
<P>In the /etc/rc.d/rc.firewall ruleset:
<PRE>
... start of -I rules ...

# reject and log local interface, local machines going to 204.50.10.13
#
/sbin/ipfwadm -I -a reject -V 192.168.0.1 -S 192.168.0.0/24 -D 204.50.10.13/32 -o

# local interface, local machines, going anywhere is valid
#
/sbin/ipfwadm -I -a accept -V 192.168.0.1 -S 192.168.0.0/24 -D 0.0.0.0/0

... end of -I rules ...
</PRE>
<P>
<P>Using -O (output) rules: 
<P>This is the slower method to block traffic because the packets go through masquerading first before they are dropped.  Yet, this rule even stops the firewall machine from accessing the forbidden site.
<P>
<P>
<PRE>
... start of -O rules ...

# reject and log outgoing to 204.50.10.13
#
/sbin/ipfwadm -O -a reject -V $ppp_ip -S $ppp_ip/32 -D 204.50.10.13/32 -o

# anything else outgoing on remote interface is valid
#
/sbin/ipfwadm -O -a accept -V $ppp_ip -S $ppp_ip/32 -D 0.0.0.0/0

... end of -O rules ...
</PRE>
<P>Using -F (forward) rules: 
<P>Probably slower than -I (input) rules for blocking traffic, this still only stops masqueraded machines (e.g. internal machines).   The firewall machine can still reach forbidden site(s).
<P>
<PRE>
... start of -F rules ...

# Reject and log from local net on PPP interface to 204.50.10.13.
#
/sbin/ipfwadm -F -a reject -W ppp0 -S 192.168.0.0/24 -D 204.50.10.13/32 -o

# Masquerade from local net on local interface to anywhere.
#
/sbin/ipfwadm -F -a masquerade -W ppp0 -S 192.168.0.0/24 -D 0.0.0.0/0

... end of -F rules ...
</PRE>
<P>There is no need for a special rule to allow machines on the 192.168.0.0/24 network to go to 204.50.11.0. Why?  It is already covered by the global MASQ rule.
<P>NOTE:  There is more than one way of coding the interfaces in the above rules.  For example instead of "-V 192.168.255.1" you can code "-W eth0", instead of "-V $ppp_ip" , you can use "-W ppp0".  The "-V" method was phased out with the imgration to IPCHAINS but for IPFWADM users, its personal choice and documentation more than anything.
<P>
<P>
<H2><A NAME="ss6.5">6.5 Stronger IP Firewall (IPCHAINS) rulesets </A>
</H2>

<P>
<P>
<A NAME="Strong-IPCHAINS-Rulesets"></A> <P>This section provides a more in-depth guide on using the 2.2.x firewall tool, IPCHAINS.  See above for IPFWADM rulesets.
<P>This example is for a firewall/masquerade system behind a PPP link with a static PPP address (dynamic PPP instructions are included
but disabled).  The trusted interface is 192.168.0.1 and the PPP interface IP address has been changed to protect the guilty :).  I
have listed each incoming and outgoing interface individually to catch IP spoofing as well as stuffed routing and/or masquerading. A
nything not explicitly allowed is <B>FORBIDDEN</B> (well.. rejected actually).  If your IP MASQ box breaks after implementing this
rc.firewall script, be sure that you edited it for your configuration and check your /var/log/messages or /var/adm/messages SYSLOG
file for any firewall errors.
<P>For more comprehensive examples of a strong IP Masqueraded IPFWADM rulesets for PPP, Cablemodem users, etc.,
please see 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> and 
<A HREF="http://www.greatcircle.com/">GreatCircle's Firewall WWW page</A><P><B>NOTE #1: </B>Linux 2.2.x kernels less than 2.2.16 have a TCP root exploit vunerability and versions less than 2.2.11 have a IPCHAINS fragmentation bug.  Because of this, people running strong IPCHAINS rulesets are open to attack.  Please upgrade your kernel to a fixed version.
<P><B>NOTE #2:</B> If you get a dynamically assigned TCP/IP address from your ISP (PPP, ADSL, Cablemodems, etc.), you <B>CANNOT load</B> this strong ruleset upon boot.  You will either need to reload this firewall ruleset EVERY TIME you get a new IP address or make your /etc/rc.d/rc.firewall ruleset more intelligent.  To do this for PPP users, carefully read and un-comment out the properly lines in the "Dynamic PPP IP fetch" section below.   You can also find more details in the 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> doc for more details on Strong rulesets and Dynamic IP addresses.  
<P><B>Please also be aware that there are several GUI Firewall creation tools available as well.  Please see the 
<A HREF="IP-Masquerade-HOWTO-7.html#FAQ">FAQ</A>
 section for full details.</B>
<P>Lastly, if you are using a STATIC PPP IP address, change the "ppp_ip="your.static.PPP.address"" line to reflect your address.
<P>----------------------------------------------------------------
<P>
<P>
<A NAME="stronger-rc.firewall-2.2.x"></A> <P>
<PRE>

#!/bin/sh
#
# /etc/rc.d/rc.firewall: An example of a Semi-Strong IPCHAINS firewall ruleset. 
#

PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Load all required IP MASQ modules
#
#   NOTE:  Only load the IP MASQ modules you need.  All current IP MASQ modules
#          are shown below but are commented from loading.

# Needed to initially load modules
#
/sbin/depmod -a

# Supports the proper masquerading of FTP file transfers using the PORT method
#
/sbin/modprobe ip_masq_ftp

# Supports the masquerading of RealAudio over UDP.  Without this module,
#       RealAudio WILL function but in TCP mode.  This can cause a reduction
#       in sound quality
#
/sbin/modprobe ip_masq_raudio

# Supports the masquerading of IRC DCC file transfers
#
#/sbin/modprobe ip_masq_irc


# Supports the masquerading of Quake and QuakeWorld by default.  This modules is
#   for for multiple users behind the Linux MASQ server.  If you are going to 
#   play Quake I, II, and III, use the second example.
#
#   NOTE:  If you get ERRORs loading the QUAKE module, you are running an old
#   -----  kernel that has bugs in it.  Please upgrade to the newest kernel.
#
#Quake I / QuakeWorld (ports 26000 and 27000)
#/sbin/modprobe ip_masq_quake
#
#Quake I/II/III / QuakeWorld (ports 26000, 27000, 27910, 27960)
#/sbin/modprobe ip_masq_quake 26000,27000,27910,27960


# Supports the masquerading of the CuSeeme video conferencing software
#
#/sbin/modprobe ip_masq_cuseeme

#Supports the masquerading of the VDO-live video conferencing software
#
#/sbin/modprobe ip_masq_vdolive


#CRITICAL:  Enable IP forwarding since it is disabled by default since
#
#           Redhat Users:  you may try changing the options in 
#                          /etc/sysconfig/network from:
#
#                       FORWARD_IPV4=false
#                             to
#                       FORWARD_IPV4=true
#
echo "1" > /proc/sys/net/ipv4/ip_forward


#CRITICAL:  Enable automatic IP defragmenting since it is disabled by default 
#           in 2.2.x kernels 
#
#           This used to be a compile-time option but the behavior was changed 
#           in 2.2.12.  It should also be noted that some distributions have
#           removed this option from the /proc table.  If this entry isn't
#           present in your /proc, don't worry about it.
#
echo "1" > /proc/sys/net/ipv4/ip_always_defrag


# Dynamic IP users:
#
#   If you get your IP address dynamically from SLIP, PPP, or DHCP, enable this #   following option.  This enables dynamic-ip address hacking in IP MASQ, 
#   making the life with Diald and similar programs much easier.
#
#echo "1" > /proc/sys/net/ipv4/ip_dynaddr


# Enable the LooseUDP patch which some Internet-based games require
#
#  If you are trying to get an Internet game to work through your IP MASQ box,
#  and you have set it up to the best of your ability without it working, try
#  enabling this option (delete the "#" character).  This option is disabled
#  by default due to possible internal machine UDP port scanning
#  vunerabilities.
#
#echo "1" > /proc/sys/net/ipv4/ip_masq_udp_dloose


# Specify your Static IP address here.
#
#   If you have a DYNAMIC IP address, you need to make this ruleset understand 
#   your IP address everytime you get a new IP.  To do this, enable the 
#   following one-line script.  (Please note that the different single and 
#   double quote characters MATTER).
#
#
#   DHCP users:
#   -----------
#   If you get your TCP/IP address via DHCP, **you will need ** to enable the 
#   #ed out command below underneath the PPP section AND replace the word 
#   "ppp0" with the name of your EXTERNAL Internet connection (eth0, eth1, etc) 
#   on the lines for "ppp-ip" and "extip".  It should be also noted that the 
#   DHCP server can change IP addresses on you.  To fix this, users should 
#   configure their DHCP client to re-run the firewall ruleset everytime the 
#   DHCP lease is renewed.
#
#     NOTE #1:  Some DHCP clients like the original "pump" (the newer
#               versions have been fixed) did NOT have the ability to run 
#               scripts after a lease-renew.  Because of this, you need to 
#               replace it with something like "dhcpcd" or "dhclient".
#
#     NOTE #2:  The syntax for "dhcpcd" has changed in recent versions.
#
#               Older versions used syntax like:
#                         dhcpcd -c /etc/rc.d/rc.firewall eth0
#
#               Newer versions use syntax like:
#                         dhcpcd eth0 /etc/rc.d/rc.firewall
#
#     NOTE #3:  For Pump users, put the following line in /etc/pump.conf:
#
#                   script /etc/rc.d/rc.firewall
#
#   PPP users:
#   ----------
#   If you aren't already aware, the /etc/ppp/ip-up script is always run when 
#   a PPP connection comes up.  Because of this, we can make the ruleset go and 
#   get the new PPP IP address and update the strong firewall ruleset.
#
#   If the /etc/ppp/ip-up file already exists, you should edit it and add a line
#   containing "/etc/rc.d/rc.firewall" near the end of the file.
#
#   If you don't already have a /etc/ppp/ip-up sccript, you need to create the 
#   following link to run the /etc/rc.d/rc.firewall script.
#
#       ln -s /etc/rc.d/rc.firewall /etc/ppp/ip-up
#
#   * You then want to enable the #ed out shell command below *
#
#
# PPP and DHCP Users:
# -------------------
# Remove the # on the line below and place a # in front of the line after that.
#
#extip="`/sbin/ifconfig ppp0 | grep 'inet addr' | awk '{print $2}' | sed -e 's/.*://'`"

# For PPP users with STATIC IP addresses:
#
extip="your.static.PPP.address"

# ALL PPP and DHCP users must set this for the correct EXTERNAL interface name
extint="ppp0"

# Assign the internal IP
intint="eth0"
intnet="192.168.0.0/24"


# MASQ timeouts
#
#   2 hrs timeout for TCP session timeouts
#  10 sec timeout for traffic after the TCP/IP "FIN" packet is received
#  60 sec timeout for UDP traffic (MASQ'ed ICQ users must enable a 30sec firewall timeout in ICQ itself)
#
ipchains -M -S 7200 10 60

#############################################################################
# Incoming, flush and set default policy of reject. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
ipchains -F input
ipchains -P input REJECT

# local interface, local machines, going anywhere is valid
#
ipchains -A input -i $intint -s $intnet -d 0.0.0.0/0 -j ACCEPT

# remote interface, claiming to be local machines, IP spoofing, get lost
#
ipchains -A input -i $extint -s $intnet -d 0.0.0.0/0 -l -j REJECT

# remote interface, any source, going to permanent PPP address is valid
#
ipchains -A input -i $extint -s 0.0.0.0/0 -d $extip/32 -j ACCEPT

# loopback interface is valid.
#
ipchains -A input -i lo -s 0.0.0.0/0 -d 0.0.0.0/0 -j ACCEPT

# catch all rule, all other incoming is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
ipchains -A input -s 0.0.0.0/0 -d 0.0.0.0/0 -l -j REJECT

#############################################################################
# Outgoing, flush and set default policy of reject. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
ipchains -F output
ipchains -P output REJECT

# local interface, any source going to local net is valid
#
ipchains -A output -i $intint -s 0.0.0.0/0 -d $intnet -j ACCEPT

# outgoing to local net on remote interface, stuffed routing, deny
#
ipchains -A output -i $extint -s 0.0.0.0/0 -d $intnet -l -j REJECT

# outgoing from local net on remote interface, stuffed masquerading, deny
#
ipchains -A output -i $extint -s $intnet -d 0.0.0.0/0 -l -j REJECT

# anything else outgoing on remote interface is valid
#
ipchains -A output -i $extint -s $extip/32 -d 0.0.0.0/0 -j ACCEPT

# loopback interface is valid.
#
ipchains -A output -i lo -s 0.0.0.0/0 -d 0.0.0.0/0 -j ACCEPT

# catch all rule, all other outgoing is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
ipchains -A output -s 0.0.0.0/0 -d 0.0.0.0/0 -l -j REJECT

#############################################################################
# Forwarding, flush and set default policy of deny. Actually the default policy
# is irrelevant because there is a catch all rule with deny and log.
#
ipchains -F forward
ipchains -P forward DENY

# Masquerade from local net on local interface to anywhere.
#
ipchains -A forward -i $extint -s $intnet -d 0.0.0.0/0 -j MASQ
#
# catch all rule, all other forwarding is denied and logged. pity there is no
# log option on the policy but this does the job instead.
#
ipchains -A forward -s 0.0.0.0/0 -d 0.0.0.0/0 -l -j REJECT

#End of file.
</PRE>
<P>With IPCHAINS, you can block traffic to a particular site using the "input", "output", and/or "forward" rules.  Remember that the set of rules are scanned t op to bottom and "-A" tells IPCHIANS to "append" this new rule to the existing set of rules.  So with this in mind, any specific restrictions need to come bef ore global rules. For example:
<P>Using "input" rules:  
<P>Probably the fastest and most efficient method to block traffic but it only stops the MASQed machines and NOT the firewall machine itself. Of course you might want to allow that combination.
<P>Anyway, to block 204.50.10.13:
<P>In the /etc/rc.d/rc.firewall ruleset:
<PRE>
... start of "input" rules ...

# reject and log local interface, local machines going to 204.50.10.13
#
ipchains -A input -s 192.168.0.0/24 -d 204.50.10.13/32 -l -j REJECT


# local interface, local machines, going anywhere is valid
#
ipchains -A input -s 192.168.0.0/24 -d 0.0.0.0/0 -l -j ACCEPT


... end of "input" rules ...
</PRE>
<P>
<P>Using "output" rules:  
<P>This is the slower method to block traffic because the packets must go through masquerading first before they are dropped.  Yet, this rule even stops the firewall machine from accessing the forbidden site.
<P>
<PRE>
... start of "output" rules ...

# reject and log outgoing to 204.50.10.13
#
ipchains -A output -s $ppp_ip/32 -d 204.50.10.13/32 -l -j REJECT


# anything else outgoing on remote interface is valid
#
ipchains -A output -s $ppp_ip/32 -d 0.0.0.0/0 -l -j ACCEPT


... end of "output" rules ...
</PRE>
<P>Using "forward" rules:  
<P>Probably slower than "input" rules for blocking traffic, this still only stops masqueraded machines (e.g. internal machines).  The firewall machine can still reach forbidden site(s).
<P>
<P>
<PRE>
... start of "forward" rules ...

# Reject and log from local net on PPP interface to 204.50.10.13.
#
ipchains -A forward -i ppp0 -s 192.168.0.0/24 -d 204.50.10.13/32 -l -j REJECT


# Masquerade from local net on local interface to anywhere.
#
ipchains -A forward -i ppp0 -s 192.168.0.0/24 -d 0.0.0.0/0 -j MASQ

... end of "forward" rules ...
</PRE>
<P>No need for a special rule to allow machines on the 192.168.0.0/24 network to go to 204.50.11.0. Why?  It is already covered by the global MASQ rule.
<P>NOTE: Unlike IPFWADM, IPCHIANS has only one way of coding the interfaces name.  IPCHAINS uses the "-i eth0" option where as IPFWADM had both "-W" for the interface name and "-V" for the interface's IP address.
<P>
<A NAME="multiple-masqed-lans"></A> <P>
<H2><A NAME="ss6.6">6.6 IP Masquerading multiple internal networks</A>
</H2>

<P>Masquerading more than one internal network is fairly simple.  You need to first make sure that all of your networks are running correctly (both internal and external).  You then need to enable traffic to pass to both the other internal interfaces and to be MASQed to the Internet.
<P>Next, you need to enable Masquerading on the INTERNAL interfaces.  This example uses a total of THREE interfaces:  eth0 is the EXTERNAL connection to the Internet, eth1 is the 192.168.0.0 network, and eth2 is the 192.168.1.0 network.  Both eth1 and eth2 will be MASQed out of interface eth0.  In your rc.firewall ruleset next to the existing MASQ enable line, add the following:
<P>
<UL>
<LI>2.2.x kernels with IPCHAINS
<PRE>
  #Enable internal interfaces to communication between each other
  /sbin/ipchains -A forward -i eth1 -d 192.168.0.0/24
  /sbin/ipchains -A forward -i eth2 -d 192.168.1.0/24

  #Enable internal interfaces to MASQ out to the Internet
  /sbin/ipchains -A forward -j MASQ -i eth0 -s 192.168.0.0/24 -d 0.0.0.0/0
  /sbin/ipchains -A forward -j MASQ -i eth0 -s 192.168.1.0/24 -d 0.0.0.0/0
  
</PRE>

<P>
</LI>
<LI>2.0.x kernels with IPFWADM
<PRE>
  #Enable internal interfaces to communication between each other
  /sbin/ipfwadm -F -a accept -V 192.168.0.1 -D 192.168.1.0/24
  /sbin/ipfwadm -F -a accept -V 192.168.1.1 -D 192.168.0.0/24

  #Enable internal interfaces to MASQ out to the Internet 
  /sbin/ipfwadm -F -a masq -W eth0 -S 192.168.0.0/24 -D 0.0.0.0/0
  /sbin/ipfwadm -F -a masq -W eth0 -S 192.168.1.0/24 -D 0.0.0.0/0
</PRE>
</LI>
</UL>
<P>Please note that it is CORRECT to have "eth0" specified multiple times for the exmples shown above.  The reason for this is the Linux kernel needs to know which interface is used for OUTGOING traffic.  Since eth0 in the above examples is the Internet connection, it is listed for each internal interface.
<P>
<P>
<A NAME="Diald"></A> <P>
<H2><A NAME="ss6.7">6.7 IP Masquerade and Dial-on-Demand Connections</A>
</H2>

<P>
<P>
<OL>
<LI>If you would like to setup your network to automatically dial up the Internet, ether the <EM>Diald</EM> demand dial-up or new versions of the <EM>PPPd</EM> packages will be of great utility.  Diald is the recommended solution due to its more granular configuration.
<P>
</LI>
<LI>To setup Diald, please check out the 
<A HREF="http://home.pacific.net.sg/~harish/diald.config.html">Setting Up Diald for Linux Page</A> or 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 23</A>
<P>
</LI>
<LI>Once Diald and IP Masq have been setup properly, any MASQed client machines that initiate a web, telnet or ftp session will make the Linux box dynamically bring up its Internet link.
<P>
</LI>
<LI>There is a timeout that will occur with the first connection.  This is inevitable if you are using analog modems.  The time taken to establish the modem link and the PPP connections may cause your client program (WWW browser, etc.).  This isn't common though.  If this does happen, just retry that Internet traffic request (say a WWW page) again and it should come up fine.  You can also try setting <EM>echo "1" > /proc/sys/net/ipv4/ip_dynaddr</EM> kernel option to help with this initial setup.</LI>
</OL>
<P>
<P>
<A NAME="Forwarders"></A> <P>
<H2><A NAME="ss6.8">6.8 IPPORTFW, IPMASQADM, IPAUTOFW, REDIR, UDPRED, and other Port Forwarding tools </A>
</H2>

<P>
<P>IPPORTFW, IPAUTOFW, REDIR, UDPRED, and other programs are generic TCP and/or UDP port forwarding tools for Linux IP Masquerade.  These tools are typically used with or as a replacement for specific IP MASQ modules like the current ones for FTP, Quake, etc. With port forwarders, you can now re-direct data connections from the Internet to an internal, privately addressed machine behind your IP MASQ server.  This forwarding ability includes network protocols such as TELNET, WWW, SMTP, FTP (with a special patch - see below), ICQ, and many others.
<P>NOTE:  If you are just looking to do simple port forwarding without IP Masquerading support, you will <B>STILL NEED</B> to enable IP Masquerading in both the kernel AND in either your IPFWADM or IPCHAINS ruleset to then be able to use Linux's port forwarding tools.
<P>So why all the different choices?  IPAUTOFW, REDIR, and UDPRED (all URLs are in the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section) were the first tools available to IP MASQ users to allow this functionality.  Later, as Linux IP Masquerade matured, these tools were eventually replaced by IPPORTFW which is a more intelligent solution.  Because of the availablity of the newer tools, it is *HIGHLY DISCOURAGED* to use the old tools such as IPAUTOFW and REDIR because they don't properly notify the Linux kernel of their presence and can ultimately <B>CRASH</B> your Linux server with extreme use.  It should also be noted that there is also the newest method, MFW.  MFW's major benefit its its tigher integration with the IPCHAINS tool.  With this solution, you use a IPCHAINS ruleset to "Mark" a specific packet and then create a different chain to then do the proper forwarding.  Currently, this method isn't covered in the HOWTO.
<P><B>NOTE #2:  With PORTFW in 2.2.x kernels, <EM>internal machines</EM> CANNOT use the same PORTFWed IP address to access an internal machine though it works fine with external computers on the Internet.  If this is an issue for you, you can ALSO impliment the REDIR portfw tool to let internal machines get redirected to the internal server.  One good think to note is the upcoming 
<A HREF="IP-Masquerade-HOWTO-2.html#NetFilter">NetFilter</A>
 toolset solves this issue.  If you would like a technical explination of why this internal/external forwarding doesn't work, please page down towards the bottom of the 2.2.x PORTFW section for a note from Juan.</B>
<P>NOTE #3: The forwarding of FTP server traffic to an internal MASQed FTP server, known as <B>PORTFW FTP</B>, is now supported for both the 2.2.x and 2.2.x kernels.  This is possible either through the patching the Linux kernel sources though the support is not currently built into the main Linux kernel or using an external FTP proxy program.  It should be noted that the kernel module code is still experimental and some people get better results with ACTIVE FTP sessions compared to PASSIVE connections.  Interestingly enough, other people have seen the exact opposite behavior.  Please let us know what your results are like.  More about this is covered below in both the 2.2.x and 2.0.x sections as the solutions use different patches.
<P>
<P>Before jumping right into installing either the 2.0.x IPPORTFW or 2.2.x version of IPMASQADM with IPPORTFW support, network security can be an issue with any port forwarder.  The reason for this is because these tools basically create a hole in the packet firewall for the forwarded TCP/UDP ports.  Though this doesn't pose any threat to your Linux machine, it might be an issue to the internal machine that this traffic is being forwarded to.  No worries though, this is what Steven Clarke (the author of IPPORTFW) had to say about that:
<P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
   "Port Forwarding is only called within masquerading functions so it 
   fits inside the same IPFWADM/IPCHAINS rules. Masquerading is an extension to 
   IP forwarding. Therefore, ipportfw only sees a packet if it fits 
   both the input and masquerading ipfwadm rule sets."
</PRE>
</CODE></BLOCKQUOTE>
<P>With this said, it's important to have a strong firewall ruleset.  Please see the 
<A HREF="#Strong-IPFWADM-Rulesets">Strong-IPFWADM-Rulesets</A>
 and 
<A HREF="#Strong-IPCHAINS-Rulesets">Strong-IPCHAINS-Rulesets</A>
 sections for more details on strong rulesets.
<P>
<P>So, to install IPPORTFW forwarding support for either a 2.2.x or 2.0.x kernel, you need to re-compile the Linux kernel to support IPPORTFW.  
<UL>
<LI>2.2.x kernel users will already have the IPPORTFW kernel option available via IPMASQADM</LI>
<LI>2.0.x users will need to apply a simple kernel option patch</LI>
</UL>
<P>
<P>
<P>
<H3>IPMASQADM with IPPORTFW support on 2.2.x kernels</H3>

<P>
<P>First, make sure you have the newest 2.2.x kernel uncompressed into /usr/src/linux.  If you haven't already done this, please see the 
<A HREF="IP-Masquerade-HOWTO-3.html#Kernel-Compile">Kernel-Compile</A>
 section for full details.  Next, download the "ipmasqadm.c" program from the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.2.x-Requirements">2.2.x-Requirements</A>
 section into the /usr/src/ directory.
<P>Next, you'll need to compile the 2.2.x kernel as shown in the 
<A HREF="IP-Masquerade-HOWTO-3.html#Kernel-Compile">Kernel-Compile</A>
 section.   Be sure to say YES to the IPPORTFW option when you configure the kernel.  Once the kernel compile is complete and you have rebooted, return to this section.
<P>Now, compile and install the IPMASQADM tool:
<P>
<BLOCKQUOTE><CODE>
<PRE>
        cd /usr/src
        tar xzvf ipmasqadm-x.tgz
        cd ipmasqadm-x
        make
        make install 
</PRE>
</CODE></BLOCKQUOTE>
<P>
<P>
<P>Now, for this example, we are going to allow ALL WWW Internet traffic (port 80) hitting your Internet TCP/IP address to then be forwarded to the internal Masqueraded machine at IP address 192.168.0.10.
<P>PORTFW FTP:  As mentioned above, there are two solutions for forwarding FTP server traffic to an internal MASQed PC.  The first solution *IS* a BETA level <EM>IP_MASQ_FTP</EM> module for 2.2.x kernels to PORT Forward FTP connections to an internal MASQed FTP server.  The other method is using a FTP proxy program (the URL is in the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.2.x-Requirements">2.2.x-Requirements</A>
 section.  It should also be noted that the FTP kernel module also supports the adding of additional PORTFW FTP ports on the fly without the requirement of unloading and reloaded the IP_MASQ_FTP module and thus breaking any existing FTP transfers.  You can find more about this new code at the IPMASQ WWW site at 
<A HREF="http://ipmasq.cjb.net">http://ipmasq.cjb.net</A>.  There is also examples and some more information about PORTFWed FTP connection below in the 2.0.x. kernel section.
<P><B>NOTE: </B>Once you enable a port forwarder on port 80, that port can no longer be used by the Linux IP Masquerade server.  To be more specific, if you have a WWW server already running on the MASQ server, a port forward will now give all Internet users the WWW pages from the -INTERNAL- WWW server and not the pages on your IP MASQ server.
<P>Anyway, to enable port forwarding, edit the /etc/rc.d/rc.firewall ruleset.  Add the follow lines but be sure to replace the word "$extip" with your Internet IP address.
<P><B>NOTE:</B>  If you use get a DYNAMIC TCP/IP address from your ISP (PPP, ADSL, Cablemodems, etc.), you will NEED to make your /etc/rc.d/rc.firewall ruleset more intelligent.  To do this, please see the 
<A HREF="#Strong-IPCHAINS-Rulesets">Strong-IPCHAINS-Rulesets</A>
 section from above or 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> for more details on strong rulesets and Dynamic IP addresses.  I'll give you a hint though:  /etc/ppp/ip-up for PPP users.
<P>
<BLOCKQUOTE><CODE>
<PRE>
        /etc/rc.d/rc.firewall
        --

        #echo "Enabling IPPORTFW Redirection on the external LAN.."
        #
        /usr/sbin/ipmasqadm portfw -f
        /usr/sbin/ipmasqadm portfw -a -P tcp -L $extip 80 -R 192.168.0.10 80

        --
</PRE>
</CODE></BLOCKQUOTE>
<P>That's it!  Just re-run your /etc/rc.d/rc.firewall ruleset and test it out!
<P>If you get the error message "ipchains: setsockopt failed: Protocol not available", you AREN'T running your new kernel.  Make sure that you moved the new kernel over, re-run LILO, and then reboot again.  If you are sure you are running your new kernel, run the command "ls /proc/net/ip_masq" and make sure the "portfw" file exists.  If it doesn't, you must have made an error when configuring your kernel.  Try again.
<P>
<P>For those who want to understand why PORTFW cannot redirect traffic for both
external and internal interfaces, here is an email from Juanjo that better
explains it:
<P>
<HR>
<PRE>
From Juanjo Ciarlante
--

>If I use:
>
> ipmasqadm portfw -a -P tcp  -L 1.2.3.4 80 -R 192.168.2.3 80
>
>Everything works great from the outside but internal requests for the same
>1.2.3.4 address fail. Are there chains that will allow a machine on localnet 
>192.168.2.0 to accesss www.periapt.com without using a proxy? 

Actually not.

I usually setup a ipmasqadm rule for outside, *AND* a port
redirector for inside. This works because ipmasqadm hooks before
redir will get the eventual outside connection, _but_ leaves things
ok if not (stated by APPROPIATE rules).

The actual "conceptual" problem comes from the TRUE client (peer) IP
goal (thanks to masq) being in same net as target server.

The failing scenario for "local masq" is :
   client: 192.168.2.100
   masq:   192.168.2.1
   serv:   192.168.2.10

1)client->server packet
 a) client:  192.168.2.100:1025  -> 192.168.2.1:80   [SYN]
 b) (masq):  192.168.2.100:1025  -> 192.168.2.10:80  [SYN]
            (and keep  192.168.2.1:61000 192.168.2.100:1025 related)
 c) serv:    gets masqed packet (1b)

2)server->client packet
 a) serv:    192.168.2.10:80     -> 192.168.2.100:1025  [SYN,ACK]
 b) client:  192.168.2.100:1025  -> 192.168.2.10:80     [RST]

Now take a moment to compare (1a) with (2a).
You see, the server replied DIRECTLY to client bypassing masq (not
letting masq to UNDO the packet hacking) because it is in SAME net, so
the client resets the connection.

hope I helped.

Warm regards
Juanjo
</PRE>
<HR>
<P>
<H3>IPPORTFW on 2.0.x kernels</H3>

<P>
<P>First, make sure you have the newest 2.0.x kernel uncompressed into /usr/src/linux.  If you haven't already done this, please see the 
<A HREF="IP-Masquerade-HOWTO-3.html#Kernel-Compile">Kernel-Compile</A>
 section for full details.  Next, download the "ipportfw.c" program and the "subs-patch-x.gz" kernel patch from the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section into the /usr/src/ directory.  
<P>NOTE:  Please replace the "x" in the "subs-patch-x.gz" file name with the most current version available on the site.
<P>Next, if you plan on port forwarding FTP traffic to an internal server, you will have to apply an additional <B>NEW</B> <EM>IP_MASQ_FTP</EM> module patch found in the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section.  More details regarding this are later in this section.  Please note that this is NOT the same patch as for the 2.2.x kernels so some functionality such as the dynamic FTP PORT functionality is not present.
<P>
<P>Now, copy the IPPORTFW patch (subs-patch-x.gz) into the Linux directory
<BLOCKQUOTE><CODE>
<PRE>
        cp /usr/src/subs-patch-1.37.gz /usr/src/linux
</PRE>
</CODE></BLOCKQUOTE>
<P>Next, apply the kernel patch to create the IPPORTFW kernel option: 
<BLOCKQUOTE><CODE>
<PRE>
        cd /usr/src/linux
        zcat subs-patch-1.3x.gz | patch -p1
</PRE>
</CODE></BLOCKQUOTE>
<P>
<P>
<P>Ok, time to compile the kernel as shown in the 
<A HREF="IP-Masquerade-HOWTO-3.html#Kernel-Compile">Kernel-Compile</A>
 section.  Be sure to say YES to the IPPORTFW option now available when you configure the kernel.  Once the compile is complete and you have rebooted, return to this section.
<P>Now with a newly compiled kernel, please compile and install the actual "IPPORTFW" program
<BLOCKQUOTE><CODE>
<PRE>
        cd /usr/src
        gcc ipportfw.c -o ipportfw
        mv ipportfw /usr/local/sbin
</PRE>
</CODE></BLOCKQUOTE>
<P>
<P>
<P>Now, for this example, we are going to allow ALL WWW Internet traffic (port 80) hitting your Internet TCP/IP address to then be forwarded to the internal Masqueraded machine at IP address 192.168.0.10.  
<P><B>NOTE:</B>  Once you enable a port forwarder on port 80, that port can no longer be used by the Linux IP Masquerade server.  To be more specific, if you have a WWW server already running on the MASQ server and then you port forward port 80 to an internal MASQed computer, ALL internet users will see the WWW pages pages from the -INTERNAL- WWW server and not the pages on your IP MASQ server.  The only work around for this is to port forward some other port, say 8080, to your internal MASQ machine.  Though this will work, all Internet users will have to append <EM>:8080</EM> to the URL to then contact the internal MASQed WWW server.
<P>Anyway, to enable port forwarding, edit the <EM>/etc/rc.d/rc.firewall</EM> ruleset.  Add the follow lines but be sure to replace the word "$extip" with your Internet IP address.  
<P><B>NOTE:</B>  If you use get a DYNAMIC TCP/IP address from your ISP (PPP, ADSL, Cablemodems, etc.), you will NEED to make your /etc/rc.d/rc.firewall ruleset more intelligent.  To do this, please see the 
<A HREF="#Strong-IPCHAINS-Rulesets">Strong-IPCHAINS-Rulesets</A>
 section from above or 
<A HREF="http://www.ecst.csuchico.edu/~dranch/LINUX/index-linux.html#TrinityOS">TrinityOS - Section 10</A> for more details on strong rulesets and Dynamic IP addresses.  I'll give you a hint though:  /etc/ppp/ip-up for PPP users.
<P>
<BLOCKQUOTE><CODE>
<PRE>
        /etc/rc.d/rc.firewall
        --

        #echo "Enabling IPPORTFW Redirection on the external LAN.."
        #
        /usr/local/sbin/ipportfw -C
        /usr/local/sbin/ipportfw -A -t$extip/80 -R 192.168.0.10/80

    #Please note that PORTFWing port 20 is NOT required for ACTIVE
    #  connections as the internal FTP server will initiate this
    #  port 20 connection and it will be properly handled by the
    #  classic MASQ mechanisms.
        --
</PRE>
</CODE></BLOCKQUOTE>
<P>That's it!  Just re-run your /etc/rc.d/rc.firewall ruleset and test it out!
<P>If you get the error message "ipfwadm: setsockopt failed: Protocol not available", you AREN'T running your new kernel.  Make sure that you moved the new kernel over, re-run LILO, and then reboot again.
<P>
<P>Port Forwarding FTP servers:
<P>If you plan on port forwarding FTP to an internal machine, things get more complicated.  The reason for this is because the standard <EM>IP_MASQ_FTP</EM> kernel module wasn't written for this though some users report that it works without any problems.  Personally, without the patch, I've heard that extended file transfers in excess of 30 minutes will fail without the patch while other people swear that it works flawlessly.  Anyway, I recommend that you try the following PORTFW instruction with the STOCK ip_masq_ftp module and see if it works for you.  If it doesn't, try using the modified ip_masq_ftp module.
<P>For those who need the module, Fred Viles wrote a modified IP_MASQ_FTP module to make things work.  If you are curious what EXACTLY is the issues, download the following archive since Fred documents it quite well.  Also understand that this patch is somewhat experimental and should be treated as such.  It should be also noted that this patch is ONLY available for the 2.0.x kernels though there is a different patch available for 2.2.x kernels.
<P>So, to get the 2.0.x patch working, you need to:
<P> 
<UL>
<LI>Apply the IPPORTFW kernel patch as shown earlier in this section FIRST.
<P>
</LI>
<LI>Download the "msqsrv-patch-36" from Fred Viles's FTP server in the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section and put it into /usr/src/linux.
<P>
</LI>
<LI>Patch the kernel with this new code by running "cat msqsrv-patch-36 | patch -p1"
<P>
</LI>
<LI>Next, replace the original <EM>"ip_masq_ftp.c"</EM> kernel module with the new one
<P>
<UL>
<LI>mv /usr/src/linux/net/ipv4/ip_masq_ftp.c /usr/src/linux/net/ipv4/ip_masq_ftp.c.orig</LI>
<LI>mv /usr/src/linux/ip_masq_ftp.c /usr/src/linux/net/ipv4/ip_masq_ftp.c</LI>
</UL>
<P>
</LI>
<LI>Lastly build and install the kernel with this new code in place.</LI>
</UL>
<P>Once this is complete, edit the /etc/rc.d/rc.firewall ruleset and add the follow lines but be sure to replace the word "$extip" with your Internet IP address.
<P>This example, like above, will allow ALL FTP Internet traffic (port 21) hitting your Internet TCP/IP address to then be forwarded to the internal Masqueraded machine at IP address 192.168.0.10.
<P>NOTE:  Once you enable a port forwarder on port 21, that port can no longer be used by the Linux IP Masquerade server.  To be more specific, if you have a FTP server already running on the MASQ server, a port forward will now give all Internet users the FTP files from the -INTERNAL- FTP server and not the files on your IP MASQ server.
<P>
<BLOCKQUOTE><CODE>
<PRE>
        /etc/rc.d/rc.firewall
        --

        #echo "Enabling IPPORTFW Redirection on the external LAN.."
        #
        /usr/local/sbin/ipportfw -C
        /usr/local/sbin/ipportfw -A -t$extip/21 -R 192.168.0.10/21

        #NOTE: If you are using multiple local port numbers to PORTFW
        #      to multuple internal FTP servers (say, 21, 2121, 2112,
        #      etc, you need to configure the ip_masq_ftp nodule to
        #      listen to these ports.  To do this, edit the 
        #      /etc/rc.d/rc.firewall script as shown in this HOWTO
        #      to look like:
        #
        # /sbin/modprobe ip_masq_ftp ports=21,2121,2112
        #
        # Re-run the /etc/rc.d/rc.firewall script for these changes to
        # take effect.


        #Please note that PORTFWing port 20 is probably NOT required 
        #  for ACTIVE connections as the internal FTP server will 
        #  initiate this port 20 connection and it will be properly 
                #  handled by the classic MASQ mechanisms.
        --
</PRE>
</CODE></BLOCKQUOTE>
<P>
<P>That's it!  Just re-run your /etc/rc.d/rc.firewall ruleset and test it out!
<P>If you get the error message "ipchains: setsockopt failed: Protocol not available", you AREN'T running your new kernel.  Make sure that you moved the new kernel over, re-run LILO, and then reboot again.  If you are sure you are running your new kernel, run the command "ls /proc/net" and make sure the "ip_portfw" file exists.  If it doesn't, you must have made an error when configuring your kernel.  Try again.
<P>
<A NAME="CuSeeme"></A> <P>
<H2><A NAME="ss6.9">6.9 CU-SeeMe and Linux IP-Masquerade</A>
</H2>

<P>
<P>Linux IP Masquerade supports CuSeeme via the <EM>"ip_masq_cuseeme"</EM> kernel module.  This kernel modules should be loaded in the /etc/rc.d/rc.firewall script.  Once the "ip_masq_cuseeme" module is installed, you should be able to both initiate and receive CuSeeme connections to remote reflectors and/or users.
<P>NOTE:  It is recommended to use the IPPORTFW tool instead of the old IPAUTOFW tool for running CuSeeme.
<P>If you need more explicit information on configuring CuSeeme, see 
<A HREF="http://www.swampgas.com/vc/ipmcus.htm">Michael Owings's CuSeeMe page</A> for a Mini-HOWTO or 
<A HREF="http://ipmasq.cjb.net/">The IP Masquerade Resources</A> for a mirror of the Mini-HOWTO.
<P>
<A NAME="ICQ"></A> <P>
<H2><A NAME="ss6.10">6.10 Mirabilis ICQ </A>
</H2>

<P>There are two methods of getting ICQ to work behind a Linux MASQ server.  One solution is to use a new ICQ Masq module and the other solution is to use IPPORTFW.  
<P>The ICQ module has some benefits.  It allows for simple setup of multiple ICQ users behind a MASQ server.  It also doesn't require any special changes to the ICQ client(s).  Recently, the 2.2.x version of the module was updated to support file transfer and read-time chat.  Yet, for the 2.0.x kernel module, file transfers and real-time chat still isn't fully supported.  Anyway, I now feel this is the PREFERRED method to get ICQ working with IP Masq running on 2.2.x+ kernels.
<P>
<P>With the IPPORTFW setup, you will have to make some changes on both Linux and ICQ clients but all ICQ messaging, URLs, chat, file transfer, etc. work.
<P>If you are interested in Andrew Deryabin's 
<A HREF="mailto:djsf@usa.net">djsf@usa.net</A> ICQ IP Masq module for the 2.2.x kernels.  Please see the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.2.x-Requirements">2.2.x-Requirements</A>
 section for details.
<P>If you rather use the classic method of getting ICQ to run behind a MASQ server, follow these steps:
<UL>
<LI> First, you need to be running a Linux kernel with IPPPORTFW enabled.  Please see the 
<A HREF="#Forwarders">Forwarders</A>
 section for more details.
<P>
<UL>
<LI> Next, you need to add the following lines to your /etc/rc.d/rc.firewall file.  This example assumes that 10.1.2.3 is your external Internet IP address and your internal MASQed ICQ machine is 192.168.0.10:
<P>The following example is for a 2.0.x kernel with IPFWADM:
<P>
<PRE>
  I have included two examples here for the user:  Either once works
  fine:

  Example #1
  --
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2000 -R 192.168.0.10/2000
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2001 -R 192.168.0.10/2001
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2002 -R 192.168.0.10/2002
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2003 -R 192.168.0.10/2003
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2004 -R 192.168.0.10/2004
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2005 -R 192.168.0.10/2005
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2006 -R 192.168.0.10/2006
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2007 -R 192.168.0.10/2007
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2008 -R 192.168.0.10/2008
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2009 -R 192.168.0.10/2009
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2010 -R 192.168.0.10/2010
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2011 -R 192.168.0.10/2011
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2012 -R 192.168.0.10/2012
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2013 -R 192.168.0.10/2013
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2014 -R 192.168.0.10/2014
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2015 -R 192.168.0.10/2015
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2016 -R 192.168.0.10/2016
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2017 -R 192.168.0.10/2017
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2018 -R 192.168.0.10/2018
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2019 -R 192.168.0.10/2019
  /usr/local/sbin/ipportfw -A -t10.1.2.3/2020 -R 192.168.0.10/2020
  --

  Example #2
  --
  port=2000
  while [ $port -le 2020 ]
    do
        /usr/local/sbin/ipportfw -A t10.1.2.3/$port -R 192.168.0.10/$port
        port=$((port+1))
    done
  --

  
</PRE>
<P>The following example is for a 2.2.x kernel with IPCHAINS:
<P>
<PRE>

  I have included two examples here for the user:  Either once works
  fine:

  Example #1
  --
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2000 -R 192.168.0.10 2000
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2001 -R 192.168.0.10 2001
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2002 -R 192.168.0.10 2002
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2003 -R 192.168.0.10 2003
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2004 -R 192.168.0.10 2004
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2005 -R 192.168.0.10 2005
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2006 -R 192.168.0.10 2006
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2007 -R 192.168.0.10 2007
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2008 -R 192.168.0.10 2008
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2009 -R 192.168.0.10 2009
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2010 -R 192.168.0.10 2010
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2011 -R 192.168.0.10 2011
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2012 -R 192.168.0.10 2012
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2013 -R 192.168.0.10 2013
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2014 -R 192.168.0.10 2014
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2015 -R 192.168.0.10 2015
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2016 -R 192.168.0.10 2016
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2017 -R 192.168.0.10 2017
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2018 -R 192.168.0.10 2018
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2019 -R 192.168.0.10 2019
  /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 2020 -R 192.168.0.10 2020
  --

  Example #2
  --
  port=2000
  while [ $port -le 2020 ]
    do
        /usr/local/sbin/ipmasqadm portfw -a -P tcp -L 10.1.2.3 $port -R 192.168.0.10 $port
        port=$((port+1))
    done
  --
  
</PRE>
<P>
</LI>
<LI>Once your new rc.firewall is ready, reload the ruleset to make sure things are ok by simple typing in "/etc/rc.d/rc.firewall".  If you get any errors, you either don't have IPPORTFW support in the kernel or you made a typo in the rc.firewall file.
<P>
</LI>
<LI>Now, in ICQ's Preferences-->Connection, configure it to be "Behind a LAN" and "Behind a firewall or Proxy".  Now, click on "Firewall Settings" and configure it to be "I don't use a SOCK5 proxy".  Also note that it was repviously recommended to change ICQ's "Firewall session timeouts" to "30" seconds BUT many users have found that ICQ becomes unreliable.  It has been found that ICQ is more reliable with its stock timeout setting (don't enable that ICQ option) and simply change MASQ's timeout to 160 seconds.  You can see how to change this timeout in the 
<A HREF="IP-Masquerade-HOWTO-3.html#rc.firewall-2.0.x">rc.firewall-2.0.x</A>
 and 
<A HREF="IP-Masquerade-HOWTO-3.html#rc.firewall-2.2.x">rc.firewall-2.2.x</A>
 rulesets.  Finally, click on Next and configure ICQ to "Use the following TCP listen ports.." from "2000" to "2020".  Now click done.
<P>Now ICQ will tell you that you have to restart ICQ for the changes to take effect.  To be honest, I had to REBOOT the Windows9x machine to get things to work right but other people say otherwise.  So.. try it both ways.
</LI>
</UL>
<P>
</LI>
<LI> It should also be noted that one user told me that simply portforwarding port 4000 to his ICQ machine worked best. He reported that everything worked fine (chat, file transfers, etc) WITHOUT re-configuring ICQ from its default settings.  Your mileage might vary on this topic but I though you might like to hear about this alternative configuration.</LI>
</UL>
<P>
<A NAME="LooseUDP"></A> <P>
<H2><A NAME="ss6.11">6.11 Gamers:  The LooseUDP patch</A>
</H2>

<P>
<P>The LooseUDP patch allows NAT-friendly games that usually use UDP connections to both WORK and perform quite well behind a Linux IP Masquerade server.  Currently, LooseUDP is available as a patch for 2.0.36+ kernels and it is already built into 2.2.3+ kernels though it is now DISABLED by DEFAULT in 2.2.16+.  
<P>To get LooseUDP running on a 2.0.x kernel, follow the following steps:
<UL>
<LI>Have the newest 2.0.x kernel sources uncompressed in the /usr/src/linux directory
<P>
</LI>
<LI>ABSOLUTELY REQUIRED for v2.0.x:  Download and install the IPPORTFW patch from the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section and as described in the 
<A HREF="#Forwarders">Forwarders</A>
 Section of the HOWTO.
<P>
</LI>
<LI>Download the LooseUDP patch from the 
<A HREF="IP-Masquerade-HOWTO-2.html#2.0.x-Requirements">2.0.x-Requirements</A>
 section 
<P>Now, put the LooseUDP patch in the /usr/src/linux directory.   Once this is done, type in:
<P>
<BLOCKQUOTE><CODE>
For a compressed patch file:  zcat loose-udp-2.0.36.patch.gz | patch -p1
</CODE></BLOCKQUOTE>
<P>
<BLOCKQUOTE><CODE>
For a NON-compressed patch file:  cat loose-udp-2.0.36.patch | patch -p1
</CODE></BLOCKQUOTE>
<P>Now, depending on your version of "patch", You will then see the following text:
<P>
<BLOCKQUOTE><CODE>
<PRE>
patching file `CREDITS'
patching file `Documentation/Configure.help'
patching file `include/net/ip_masq.h'
patching file `net/ipv4/Config.in'
patching file `net/ipv4/ip_masq.c'
</PRE>
</CODE></BLOCKQUOTE>
<P>If you see the text "Hunk FAILED" only ONCE and ONLY ONCE at the very beginning of the patching, don't be alarmed.  You probably have an old patch file (this as been fixed) but it still works.  If it fails completely, make sure you have applied the IPPORTFW kernel patch FIRST.
<P>Once the patch is installed, re-configure the kernel as shown in the 
<A HREF="IP-Masquerade-HOWTO-3.html#Kernel-Compile">Kernel-Compile</A>
 section and be sure to say "Y" to the "IP: loose UDP port managing (EXPERIMENTAL) (CONFIG_IP_MASQ_LOOSE_UDP) [Y/n/?]" option.
</LI>
</UL>
<P>To get LooseUDP running on a 2.2.x kernel, follow the following steps:
<UL>
<LI>In the /etc/rc.d/rc.firewall script, goto the BOTTOM of the file and find the LooseUDP section.  Change the "0" in the line:
<CODE>echo "0" > /proc/sys/net/ipv4/ip_masq_udp_dloose</CODE>
to a "1" and re-run the rc.firewall ruleset.  An example of this is given in both the 
<A HREF="IP-Masquerade-HOWTO-3.html#rc.firewall-2.2.x">rc.firewall-2.2.x</A>
 example and the 
<A HREF="#stronger-rc.firewall-2.2.x">stronger-rc.firewall-2.2.x</A>
 example.</LI>
</UL>
<P>Once you are running the new LooseUDP enabled kernel, you should be good to go for most NAT-friendly games.  Some URLs have been given for patches to make games like BattleZone and others NAT friendly.  Please see the 
<A HREF="#Game-Clients">Game-Clients</A>
 section for more details.
<P>
<P>
<P>
<HR>
<A HREF="IP-Masquerade-HOWTO-7.html"><IMG SRC="../img/next.gif" ALT="Next"></A>
<A HREF="IP-Masquerade-HOWTO-5.html"><IMG SRC="../img/prev.gif" ALT="Previous"></A>
<A HREF="IP-Masquerade-HOWTO.html#toc6"><IMG SRC="../img/toc.gif" ALT="Contents"></A>
<SCRIPT>EndPage();</SCRIPT>  </BODY>
</HTML>
