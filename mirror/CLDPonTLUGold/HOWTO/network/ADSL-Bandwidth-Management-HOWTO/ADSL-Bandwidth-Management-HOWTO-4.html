<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="zh-TW" xml:lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>4. 執行</title>
<link href="ADSL-Bandwidth-Management-HOWTO-5.html" rel="next" title="5.測試"/>
<link href="ADSL-Bandwidth-Management-HOWTO-3.html" rel="previous" title="3.工作原理"/>
<link href="http://tldp.org/HOWTO/ADSL-Bandwidth-Management-HOWTO/index.html" rel="alternate" title="原版" />
<link href="../../style.css" rel="stylesheet" type="text/css" />
<link href="index.html" rel="start" title="HOWTO：ADSL Bandwidth Management" />
<link href="index.html#content" rel="contents" />
<meta http-equiv="PICS-Label" content='(PICS-1.1 "http://www.icra.org/ratingsv02.html"  labels ratings (ca 1 lz 1 nz 1 oz 1 vz 1) "http://www.rsac.org/ratingsv01.html"  labels ratings (n 0 s 0 v 0 l 0))'/>
<link href="ADSL-Bandwidth-Management-HOWTO-1.html" rel="chapter" title="1.介紹" />
<link href="ADSL-Bandwidth-Management-HOWTO-2.html" rel="chapter" title="2.背景" />
<link href="ADSL-Bandwidth-Management-HOWTO-3.html" rel="chapter" title="3.工作原理" />
<link href="ADSL-Bandwidth-Management-HOWTO-4.html" rel="chapter" title="4.執行" />
<link href="ADSL-Bandwidth-Management-HOWTO-5.html" rel="chapter" title="5.測試" />
<link href="ADSL-Bandwidth-Management-HOWTO-6.html" rel="chapter" title="6.OK It Works!! Now What?" />
<link href="ADSL-Bandwidth-Management-HOWTO-4.html#ss4.1" rel="section" title="4.1 Caveats " />
<link href="ADSL-Bandwidth-Management-HOWTO-4.html#ss4.2" rel="section" title="4.2 Script: myshaper" />
<link href="ADSL-Bandwidth-Management-HOWTO.rdf" rel="meta" title="各章節的說明資訊" />
</head> <body>
<table >
  <tr>
    <th colspan="3" class="HdTitle">HOWTO：The
      Linux Distribution</th>
  </tr>
  <tr>
    <td class="TtdL"> <a href="ADSL-Bandwidth-Management-HOWTO-3.html" accesskey="P">上一頁(P)</a> </td>
    <td class="TtdC">&nbsp;</td>
    <td class="TtdR"> <a href="ADSL-Bandwidth-Management-HOWTO-5.html" accesskey="N">下一頁(N)</a> </td>
  </tr>
</table>
<hr />
<h1>4. 執行</h1>

<h2><a name="ss4.1" id="ss4.1"></a>4.1 Caveats </h2>

<p>限制發送至DSL modem的數據速率不像看起似的那麼簡單. 大多數 DSL modems 以經真正地在您的ISP閘道和
linux box 之間建立了傳輸數據的以太網橋接.
大多數的 DSL modems 使用ATM作為發送數據的連接層.
ATM 總是以53bytes/單元 的形式發送數據.這些數據當中的 5bytes 是信息頭
,餘下的48bytes才是傳輸的數據.既使您發送1byte的數據,也將因為ATM 總是以 53bytes/單元 
的形式發送數據而消耗53bytes的帶寬. 這表示您將發送一個由
0 bytes 數據 + 20 bytes TCP 報頭 + 20 bytes IP 報頭 + 18 bytes 以太網報頭 組成的TCP ACK數據包.
實際上,既使您發送的以太網數據包只有40bytes的有效負載 (TCP and IP header), 
最小的以太網數據包有效負載數據是46bytes,所以另外的6bytes是空的負載.
這意味著實際以太網數據包加上報頭是 18 + 46 = 64 bytes.
在ATM的規則中,如果發送64bytes的數據,您將發送兩個總共佔據106bytes帶寬的ATM cells(單元).
這表示每發送一個TCP ACK 數據包, 您會浪費掉42bytes的帶寬. 
如果 Linux 計算 DSL modem 使用的封裝就沒什麼問題了,
但是, Linux 只計算 TCP header, IP header, 和 14 bytes 的 MAC 地址. 
(Linux 不計算 4 bytes 的 CRC 因為這是用來控制硬體層的). 
Linux 不會將以太網數據包的最小值計算為 46 bytes, 也不會去計算固定的 ATM 單元的大小.</p>

<p>這些所有的都表示您限制的出站帶寬比實際上的要低一點.您必需找到最適合您自己的限制值.
但是當您下載一個大文件時網絡的反應時間就會暴漲至3秒以上.
因為Linux在帶寬消耗計算的誤差, 所以這很可發生.</p>

<p>I have been working on a solution to this problem for a few months and have almost settled on a solution that I will soon release to the public for further testing. 
The solution involves using a user-space queue instead of linux's QoS to rate-limit packets. 
I've basically implemented a simple HTB queue using linux user-space queues. 
This solution (so far) has been able to regulate outbound traffic SO WELL that even during 
a massive bulk download (several streams) and bulk upload (gnutella, several streams) 
the latency PEAKS at 400ms over my nominal no-traffic latency of about 15ms. For more information on this QoS method,
subscribe to the email list for updates or check back on updates to this HOWTO. </p>

<h2><a name="ss4.2" id="ss4.2"></a>4.2 Script: myshaper </h2>

<p>下面是我用來控制自己路由器的script. 出站的通訊依據類型放入至7個隊列當中.
入站的通訊放入至兩個與TCP數據(如果入站數據超出速率,TCP數據包就被丟棄)有關的隊列中(lowest priority). 
script 當中給出的速率看上去工作得很好,這是適合我自己的設定,對於您來說結果可能不大相同.</p>

<p>這個 script 是在 ADSL WonderShaper 的基礎上寫出來的,請參照: <a href="http://www.lartc.org/"> 
  LARTC website</a>.</p>
<pre class="sample">
#!/bin/bash
#
# myshaper - DSL/Cable modem outbound traffic shaper and prioritizer.
#            Based on the ADSL/Cable wondershaper (www.lartc.org)
#
# Written by Dan Singletary (8/7/02)
#
# NOTE!! - This script assumes your kernel has been patched with the
#          appropriate HTB queue and IMQ patches available here:
#          (subnote: future kernels may not require patching)
#
#       http://luxik.cdi.cz/~devik/qos/htb/
#       http://luxik.cdi.cz/~patrick/imq/
#
# Configuration options for myshaper:
#  DEV    - set to ethX that connects to DSL/Cable Modem
#  RATEUP - set this to slightly lower than your
#           outbound bandwidth on the DSL/Cable Modem.
#           I have a 1500/128 DSL line and setting
#           RATEUP=90 works well for my 128kbps upstream.
#           However, your mileage may vary.
#  RATEDN - set this to slightly lower than your
#           inbound bandwidth on the DSL/Cable Modem.
#
#
#  Theory on using imq to &quot;shape&quot; inbound traffic:
#
#     It's impossible to directly limit the rate of data that will
#  be sent to you by other hosts on the internet.  In order to shape
#  the inbound traffic rate, we have to rely on the congestion avoidance
#  algorithms in TCP.  Because of this, WE CAN ONLY ATTEMPT TO SHAPE
#  INBOUND TRAFFIC ON TCP CONNECTIONS.  This means that any traffic that
#  is not tcp should be placed in the high-prio class, since dropping
#  a non-tcp packet will most likely result in a retransmit which will
#  do nothing but unnecessarily consume bandwidth.  
#     We attempt to shape inbound TCP traffic by dropping tcp packets
#  when they overflow the HTB queue which will only pass them on at
#  a certain rate (RATEDN) which is slightly lower than the actual
#  capability of the inbound device.  By dropping TCP packets that
#  are over-rate, we are simulating the same packets getting dropped
#  due to a queue-overflow on our ISP's side.  The advantage of this
#  is that our ISP's queue will never fill because TCP will slow it's
#  transmission rate in response to the dropped packets in the assumption
#  that it has filled the ISP's queue, when in reality it has not.
#     The advantage of using a priority-based queuing discipline is
#  that we can specifically choose NOT to drop certain types of packets
#  that we place in the higher priority buckets (ssh, telnet, etc).  This
#  is because packets will always be dequeued from the lowest priority class
#  with the stipulation that packets will still be dequeued from every
#  class fairly at a minimum rate (in this script, each bucket will deliver
#  at least it's fair share of 1/7 of the bandwidth).  
#
#  Reiterating main points:
#   * Dropping a tcp packet on a connection will lead to a slower rate
#     of reception for that connection due to the congestion avoidance algorithm.
#   * We gain nothing from dropping non-TCP packets.  In fact, if they
#     were important they would probably be retransmitted anyways so we want to
#     try to never drop these packets.  This means that saturated TCP connections
#     will not negatively effect protocols that don't have a built-in retransmit like TCP.
#   * Slowing down incoming TCP connections such that the total inbound rate is less
#     than the true capability of the device (ADSL/Cable Modem) SHOULD result in little
#     to no packets being queued on the ISP's side (DSLAM, cable concentrator, etc).  Since
#     these ISP queues have been observed to queue 4 seconds of data at 1500Kbps or 6 megabits
#     of data, having no packets queued there will mean lower latency.
#
#  Caveats (questions posed before testing):
#   * Will limiting inbound traffic in this fashion result in poor bulk TCP performance?
#     - Preliminary answer is no!  Seems that by prioritizing ACK packets (small &lt;64b)
#       we maximize throughput by not wasting bandwidth on retransmitted packets
#       that we already have.
#   

# NOTE: The following configuration works well for my 
# setup: 1.5M/128K ADSL via Pacific Bell Internet (SBC Global Services)

DEV=eth0
RATEUP=90
RATEDN=700  # Note that this is significantly lower than the capacity of 1500.
            # Because of this, you may not want to bother limiting inbound traffic
            # until a better implementation such as TCP window manipulation can be used.

# 
# End Configuration Options
#

if [ &quot;$1&quot; = &quot;status&quot; ]
then
        echo &quot;[qdisc]&quot;
        tc -s qdisc show dev $DEV
        tc -s qdisc show dev imq0
        echo &quot;[class]&quot;
        tc -s class show dev $DEV
        tc -s class show dev imq0
        echo &quot;[filter]&quot;
        tc -s filter show dev $DEV
        tc -s filter show dev imq0
        echo &quot;[iptables]&quot;
        iptables -t mangle -L MYSHAPER-OUT -v -x 2&gt; /dev/null
        iptables -t mangle -L MYSHAPER-IN -v -x 2&gt; /dev/null
        exit
fi

# Reset everything to a known state (cleared)
tc qdisc del dev $DEV root    2&gt; /dev/null &gt; /dev/null
tc qdisc del dev imq0 root 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -D POSTROUTING -o $DEV -j MYSHAPER-OUT 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -F MYSHAPER-OUT 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -X MYSHAPER-OUT 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -D PREROUTING -i $DEV -j MYSHAPER-IN 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -F MYSHAPER-IN 2&gt; /dev/null &gt; /dev/null
iptables -t mangle -X MYSHAPER-IN 2&gt; /dev/null &gt; /dev/null
ip link set imq0 down 2&gt; /dev/null &gt; /dev/null
rmmod imq 2&gt; /dev/null &gt; /dev/null

if [ &quot;$1&quot; = &quot;stop&quot; ] 
then 
        echo &quot;Shaping removed on $DEV.&quot;
        exit
fi

###########################################################
#
# Outbound Shaping (limits total bandwidth to RATEUP)

# set queue size to give latency of about 2 seconds on low-prio packets
ip link set dev $DEV qlen 30

# changes mtu on the outbound device.  Lowering the mtu will result
# in lower latency but will also cause slightly lower throughput due 
# to IP and TCP protocol overhead.
ip link set dev $DEV mtu 1000

# add HTB root qdisc
tc qdisc add dev $DEV root handle 1: htb default 26

# add main rate limit classes
tc class add dev $DEV parent 1: classid 1:1 htb rate ${RATEUP}kbit

# add leaf classes - We grant each class at LEAST it's &quot;fair share&quot; of bandwidth.
#                    this way no class will ever be starved by another class.  Each
#                    class is also permitted to consume all of the available bandwidth
#                    if no other classes are in use.
tc class add dev $DEV parent 1:1 classid 1:20 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 0
tc class add dev $DEV parent 1:1 classid 1:21 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 1
tc class add dev $DEV parent 1:1 classid 1:22 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 2
tc class add dev $DEV parent 1:1 classid 1:23 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 3
tc class add dev $DEV parent 1:1 classid 1:24 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 4
tc class add dev $DEV parent 1:1 classid 1:25 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 5
tc class add dev $DEV parent 1:1 classid 1:26 htb rate $[$RATEUP/7]kbit ceil ${RATEUP}kbit prio 6

# attach qdisc to leaf classes - here we at SFQ to each priority class.  SFQ insures that
#                                within each class connections will be treated (almost) fairly.
tc qdisc add dev $DEV parent 1:20 handle 20: sfq perturb 10
tc qdisc add dev $DEV parent 1:21 handle 21: sfq perturb 10
tc qdisc add dev $DEV parent 1:22 handle 22: sfq perturb 10
tc qdisc add dev $DEV parent 1:23 handle 23: sfq perturb 10
tc qdisc add dev $DEV parent 1:24 handle 24: sfq perturb 10
tc qdisc add dev $DEV parent 1:25 handle 25: sfq perturb 10
tc qdisc add dev $DEV parent 1:26 handle 26: sfq perturb 10

# filter traffic into classes by fwmark - here we direct traffic into priority class according to
#                                         the fwmark set on the packet (we set fwmark with iptables
#                                         later).  Note that above we've set the default priority
#                                         class to 1:26 so unmarked packets (or packets marked with
#                                         unfamiliar IDs) will be defaulted to the lowest priority
#                                         class.
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 20 fw flowid 1:20
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 21 fw flowid 1:21
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 22 fw flowid 1:22
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 23 fw flowid 1:23
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 24 fw flowid 1:24
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 25 fw flowid 1:25
tc filter add dev $DEV parent 1:0 prio 0 protocol ip handle 26 fw flowid 1:26

# add MYSHAPER-OUT chain to the mangle table in iptables - this sets up the table we'll use
#                                                      to filter and mark packets.
iptables -t mangle -N MYSHAPER-OUT
iptables -t mangle -I POSTROUTING -o $DEV -j MYSHAPER-OUT

# add fwmark entries to classify different types of traffic - Set fwmark from 20-26 according to
#                                                             desired class. 20 is highest prio.
iptables -t mangle -A MYSHAPER-OUT -p tcp --sport 0:1024 -j MARK --set-mark 23 # Default for low port traffic 
iptables -t mangle -A MYSHAPER-OUT -p tcp --dport 0:1024 -j MARK --set-mark 23 # &quot;&quot; 
iptables -t mangle -A MYSHAPER-OUT -p tcp --dport 20 -j MARK --set-mark 26     # ftp-data port, low prio
iptables -t mangle -A MYSHAPER-OUT -p tcp --dport 5190 -j MARK --set-mark 23   # aol instant messenger
iptables -t mangle -A MYSHAPER-OUT -p icmp -j MARK --set-mark 20               # ICMP (ping) - high prio, impress friends
iptables -t mangle -A MYSHAPER-OUT -p udp -j MARK --set-mark 21                # DNS name resolution (small packets)
iptables -t mangle -A MYSHAPER-OUT -p tcp --dport ssh -j MARK --set-mark 22    # secure shell
iptables -t mangle -A MYSHAPER-OUT -p tcp --sport ssh -j MARK --set-mark 22    # secure shell
iptables -t mangle -A MYSHAPER-OUT -p tcp --dport telnet -j MARK --set-mark 22 # telnet (ew...)
iptables -t mangle -A MYSHAPER-OUT -p tcp --sport telnet -j MARK --set-mark 22 # telnet (ew...)
iptables -t mangle -A MYSHAPER-OUT -p ipv6-crypt -j MARK --set-mark 24         # IPSec - we don't know what the payload is though...
iptables -t mangle -A MYSHAPER-OUT -p tcp --sport http -j MARK --set-mark 25   # Local web server
iptables -t mangle -A MYSHAPER-OUT -p tcp -m length --length :64 -j MARK --set-mark 21 # small packets (probably just ACKs)
iptables -t mangle -A MYSHAPER-OUT -m mark --mark 0 -j MARK --set-mark 26      # redundant- mark any unmarked packets as 26 (low prio)

# Done with outbound shaping
#
####################################################

echo &quot;Outbound shaping added to $DEV.  Rate: ${RATEUP}Kbit/sec.&quot;

# uncomment following line if you only want upstream shaping.
# exit

####################################################
#
# Inbound Shaping (limits total bandwidth to RATEDN)

# make sure imq module is loaded

modprobe imq numdevs=1

ip link set imq0 up

# add qdisc - default low-prio class 1:21

tc qdisc add dev imq0 handle 1: root htb default 21

# add main rate limit classes
tc class add dev imq0 parent 1: classid 1:1 htb rate ${RATEDN}kbit

# add leaf classes - TCP traffic in 21, non TCP traffic in 20
#
tc class add dev imq0 parent 1:1 classid 1:20 htb rate $[$RATEDN/2]kbit ceil ${RATEDN}kbit prio 0
tc class add dev imq0 parent 1:1 classid 1:21 htb rate $[$RATEDN/2]kbit ceil ${RATEDN}kbit prio 1

# attach qdisc to leaf classes - here we at SFQ to each priority class.  SFQ insures that
#                                within each class connections will be treated (almost) fairly.
tc qdisc add dev imq0 parent 1:20 handle 20: sfq perturb 10
tc qdisc add dev imq0 parent 1:21 handle 21: red limit 1000000 min 5000 max 100000 avpkt 1000 burst 50

# filter traffic into classes by fwmark - here we direct traffic into priority class according to
#                                         the fwmark set on the packet (we set fwmark with iptables
#                                         later).  Note that above we've set the default priority
#                                         class to 1:26 so unmarked packets (or packets marked with
#                                         unfamiliar IDs) will be defaulted to the lowest priority
#                                         class.
tc filter add dev imq0 parent 1:0 prio 0 protocol ip handle 20 fw flowid 1:20
tc filter add dev imq0 parent 1:0 prio 0 protocol ip handle 21 fw flowid 1:21

# add MYSHAPER-IN chain to the mangle table in iptables - this sets up the table we'll use
#                                                         to filter and mark packets.
iptables -t mangle -N MYSHAPER-IN
iptables -t mangle -I PREROUTING -i $DEV -j MYSHAPER-IN

# add fwmark entries to classify different types of traffic - Set fwmark from 20-26 according to
#                                                             desired class. 20 is highest prio.
iptables -t mangle -A MYSHAPER-IN -p ! tcp -j MARK --set-mark 20              # Set non-tcp packets to highest priority
iptables -t mangle -A MYSHAPER-IN -p tcp -m length --length :64 -j MARK --set-mark 20 # short TCP packets are probably ACKs
iptables -t mangle -A MYSHAPER-IN -p tcp --dport ssh -j MARK --set-mark 20    # secure shell
iptables -t mangle -A MYSHAPER-IN -p tcp --sport ssh -j MARK --set-mark 20    # secure shell
iptables -t mangle -A MYSHAPER-IN -p tcp --dport telnet -j MARK --set-mark 20 # telnet (ew...)
iptables -t mangle -A MYSHAPER-IN -p tcp --sport telnet -j MARK --set-mark 20 # telnet (ew...)
iptables -t mangle -A MYSHAPER-IN -m mark --mark 0 -j MARK --set-mark 21              # redundant- mark any unmarked packets as 26 (low prio)

# finally, instruct these packets to go through the imq0 we set up above
iptables -t mangle -A MYSHAPER-IN -j IMQ

# Done with inbound shaping 
#
####################################################

echo &quot;Inbound shaping added to $DEV.  Rate: ${RATEDN}Kbit/sec.&quot;
</pre>
<p></p>
<hr />
<table >
  <tr>
    <td class="BtdL"> <a href="ADSL-Bandwidth-Management-HOWTO-3.html" accesskey="P">上一頁(P)</a> </td>
    <td class="BtdC"> <a href="index.html" accesskey="H">目錄(H)</a> </td>
    <td class="BtdR"> <a href="ADSL-Bandwidth-Management-HOWTO-5.html">下一頁(N)</a> </td>
  </tr>
  <tr>
    <td class="BtdL">工作原理</td>
    <td class="BtdC"><a href="ADSL-Bandwidth-Management-HOWTO-4.html"  accesskey="T">到頂層(T)</a></td>
    <td class="BtdR">測試</td>
  </tr>
</table>
<div> <a href="http://validator.w3.org/check/referer"><img src="../../../valid-xhtml10.png"  alt="符合 XHTML 1.0" class="ImgLogo"/></a> <a href="http://jigsaw.w3.org/css-validator/"><img class="ImgLogo" src="../../../vcss.png"  alt="符合 CSS"/></a> <a href="http://www.w3.org/WAI/WCAG1AA-Conformance" title="Explanation of Level Double-A Conformance"><img class="ImgLogo" src="../../../wcag1AA.gif" alt="Level Double-A conformance icon,  W3C-WAI Web Content Accessibility Guidelines 1.0"/></a> <a href="http://www.w3.org/RDF/" title="RDF 資源描述架構"><img  src="../../../rdf.gif" class="ImgLogo" alt="表示該網頁支援資源描述架構"/></a> <a href="http://www.icra.org/_en/"><img src="../../../icra_sw.gif" title="網路內容分級協會" alt="網路內容分級協會" class="ImgLogo"/></a></div>
</body>
</html>
